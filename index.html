<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>í¸ë°±ë‚˜ë¬´ ì£¼ì°¨ ê´€ë¦¬ ì‹œìŠ¤í…œ</title>

  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <style>
    :root {
      --primary: #34495e;
      --accent: #3182ce;
      --danger: #e53e3e;
      --joint: #f8fafc;
      --warn: #f59e0b;
      --share: #22c55e;
    }

    body {
      font-family: 'Apple SD Gothic Neo', sans-serif;
      text-align: center;
      background-color: #f4f7f9;
      margin: 0;
      padding: 20px;
      color: #333;
    }

    .container {
      max-width: 1100px;
      margin: auto;
      background: white;
      padding: 30px;
      border-radius: 20px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    }

    h1 { cursor: pointer; user-select: none; margin-bottom: 5px; padding: 10px; }

    .admin-badge {
      display: none;
      color: #3182ce;
      font-size: 14px;
      font-weight: bold;
      border: 1px solid #3182ce;
      padding: 2px 10px;
      border-radius: 20px;
      margin: 10px 0;
    }

    .summary-box {
      display: none;
      background: #fff;
      border: 3px solid var(--accent);
      padding: 25px;
      border-radius: 15px;
      margin: 20px 0 40px 0;
      text-align: left;
      line-height: 1.6;
    }

    .dong-wrapper { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 30px; }
    .dong-column { flex: 1; min-width: 300px; background: #fff; padding: 15px; border-radius: 12px; border: 1px solid #e2e8f0; }
    .dong-title { font-weight: bold; margin-bottom: 10px; padding: 8px; background: #f8fafc; border-radius: 6px; border-bottom: 2px solid var(--primary); }
    .list-item { display: flex; align-items: center; justify-content: space-between; margin-bottom: 5px; font-size: 13px; padding: 4px 10px; border-radius: 4px; border: 1px solid #f1f5f9; }

    .map-section { margin: 20px 0; padding: 20px; background: #fdfdfd; border: 1px solid #cbd5e0; border-radius: 15px; }
    .map-container { display: flex; flex-direction: column; gap: 15px; align-items: center; }
    .building-box { width: 100%; border: 2px solid var(--primary); border-radius: 10px; padding: 45px 15px 20px; position: relative; background: white; box-sizing: border-box; margin-bottom: 20px; }
    .joint-box { width: 100%; border: 1px dashed var(--accent); border-radius: 10px; padding: 25px 15px 15px; position: relative; background: var(--joint); box-sizing: border-box; margin-bottom: 20px; }
    .label { position: absolute; top: -13px; left: 20px; padding: 3px 15px; font-size: 12px; border-radius: 4px; font-weight: bold; background: var(--primary); color: white; }
    .joint-label { background: var(--accent); }

    .parking-row { display: flex; justify-content: center; gap: 8px; margin: 8px 0; flex-wrap: wrap; }

    .slot {
      width: 85px;
      height: 110px;
      border: 1px solid #dcdde1;
      border-radius: 6px;
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      background: #fff;
      white-space: pre-line;
      line-height: 1.3;
      cursor: pointer;
    }

    .slot-toggle {
      position: absolute;
      top: 6px;
      left: 6px;
      transform: scale(1.3);
      cursor: pointer;
      z-index: 20;
      display: none;
    }

    .slot.filled { background-color: #ebf8ff !important; border: 2px solid var(--accent) !important; color: var(--primary) !important; font-weight: bold; }
    .slot.is-unassigned { background-color: #f1f5f9 !important; border: 2px dashed #cbd5e0 !important; color: #94a3b8 !important; }

    .slot.manual-locked { outline: 3px solid var(--warn); outline-offset: 2px; }
    .slot.share-on { outline: 3px solid var(--share); outline-offset: 2px; }

    .type-pillar { width: 40px; background: #95a5a6; color: white; border: none; cursor: default; }
    .type-entrance { width: 100px; background: #3182ce; color: white; border: none; font-weight: bold; font-size: 11px; cursor: default; }
    .type-disabled { background-color: #2b6cb0; color: white; border: none; font-weight: bold; }

    #adminControls { display: none; margin: 20px 0; padding: 20px; background: #fef2f2; border-radius: 10px; border: 2px solid var(--danger); }
    .btn { padding: 12px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 15px; margin: 5px; transition: 0.2s; }
    .draw-btn { background: var(--primary); color: white; }
    .save-db-btn { background: #2f855a; color: white; }
    .reset-db-btn { background: var(--danger); color: white; }
    .save-img-btn { background: #718096; color: white; width: 100%; margin-top: 20px; }

    .hint { font-size: 12px; color: #64748b; margin-top: 8px; text-align: left; }

    /* ì„ì‹œê³µìœ  ë‹¬ë ¥ ëª¨ë‹¬ */
    #shareModal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.45);
      z-index: 9999;
    }
    #shareModal .card {
      max-width: 360px;
      margin: 10vh auto;
      background: #fff;
      border-radius: 14px;
      padding: 16px;
      box-shadow: 0 12px 30px rgba(0,0,0,.2);
      text-align: left;
    }
    #shareModal .title { font-weight: 800; margin-bottom: 10px; }
    #shareTarget { font-size: 13px; color: #475569; margin-bottom: 12px; }
    .field-label { display:block; font-size: 12px; color: #64748b; margin-bottom: 6px; }
    .date-input { width:100%; padding:10px; border:1px solid #e2e8f0; border-radius:10px; margin-bottom:10px; }
    .row { display:flex; gap:8px; align-items:center; font-size: 13px; color:#334155; margin-bottom: 12px; }
    .modal-actions { display:flex; gap:8px; justify-content:flex-end; }
    .m-btn { padding:10px 12px; border-radius:10px; font-weight:800; cursor:pointer; }
    .m-btn.ghost { border:1px solid #e2e8f0; background:#fff; }
    .m-btn.danger { border:none; background: var(--danger); color:#fff; }
    .m-btn.primary { border:none; background: var(--accent); color:#fff; }
  </style>
</head>

<body>
<div class="container">
  <h1 onclick="handleAdminLogin()">í¸ë°±ë‚˜ë¬´ ì£¼ì°¨ êµ¬ì—­ ë°°ì •</h1>
  <div id="adminBadge" class="admin-badge">ê´€ë¦¬ì ëª¨ë“œ í™œì„±í™”</div>

  <div id="unitWrapper" class="dong-wrapper">
    <div class="dong-column"><div class="dong-title">Aë™ ì„¸ëŒ€</div><div id="list-A"></div></div>
    <div class="dong-column"><div class="dong-title">Bë™ ì„¸ëŒ€</div><div id="list-B"></div></div>
    <div class="dong-column"><div class="dong-title">Cë™ ì„¸ëŒ€</div><div id="list-C"></div></div>
  </div>

  <div id="printArea">
    <div id="summaryArea" class="summary-box"></div>
    <div class="map-section">
      <div class="map-container" id="mainMap"></div>

      <div class="hint">
        âœ… ì•„ë¬´ë‚˜: <b>ìŠ¬ë¡¯ í´ë¦­</b> â†’ ì„ì‹œê³µìœ  ë‚ ì§œ(ë‹¬ë ¥) ì„¤ì •<br>
        ğŸ›  ê´€ë¦¬ì: <b>Shift + ìŠ¬ë¡¯ í´ë¦­</b> â†’ ìˆ˜ê¸°í‘œê¸°(ê³ ì •/ë©”ëª¨) ì…ë ¥<br>
        ğŸ›  ê´€ë¦¬ì: ì²´í¬ë°•ìŠ¤ í† ê¸€ â†’ ë¹„ì§€ì •(ì¶”ì²¨ ì œì™¸)
      </div>
    </div>
  </div>

  <div id="adminControls">
    <p style="font-weight: bold; color: var(--danger); margin-bottom: 10px;">ğŸ› ï¸ ê´€ë¦¬ì ì œì–´íŒ</p>
    <div style="display: flex; justify-content: center; flex-wrap: wrap;">
      <button class="btn draw-btn" onclick="executeDraw()">ğŸ² ê·œì¹™ëŒ€ë¡œ ì¶”ì²¨</button>
      <button class="btn save-db-btn" onclick="saveToFirebase()">ğŸ’¾ ì„œë²„ì— ê²°ê³¼ ì €ì¥</button>
      <button class="btn reset-db-btn" onclick="resetDatabase()">ğŸ§¹ ì„œë²„ ë°ì´í„° ì´ˆê¸°í™”</button>
      <button class="btn reset-db-btn" onclick="clearManualOverrides()">ğŸ§½ ìˆ˜ê¸°í‘œê¸° ì´ˆê¸°í™”</button>
    </div>
    <button class="btn save-img-btn" onclick="saveAsImage()">ğŸ“¸ í˜„ì¬ ê²°ê³¼ ì´ë¯¸ì§€ë¡œ ì €ì¥</button>
  </div>
</div>

<!-- ì„ì‹œê³µìœ  ë‚ ì§œ ì„ íƒ ëª¨ë‹¬ -->
<div id="shareModal">
  <div class="card">
    <div class="title">ì„ì‹œê³µìœ  ê¸°ê°„ ì„¤ì •</div>
    <div id="shareTarget"></div>

    <label class="field-label">ì‹œì‘ì¼</label>
    <input id="shareFrom" type="date" class="date-input">

    <label class="field-label">ì¢…ë£Œì¼</label>
    <input id="shareTo" type="date" class="date-input">

    <label class="row">
      <input id="shareOneDay" type="checkbox">
      í•˜ë£¨ë§Œ(ì‹œì‘ì¼ = ì¢…ë£Œì¼)
    </label>

    <div class="modal-actions">
      <button class="m-btn ghost" onclick="closeShareModal()">ë‹«ê¸°</button>
      <button class="m-btn danger" onclick="clearShareRange()">í•´ì œ</button>
      <button class="m-btn primary" onclick="saveShareRange()">ì €ì¥</button>
    </div>
  </div>
</div>

<script>
  // ---------------------------
  // Firebase ì„¤ì •
  // ---------------------------
  const firebaseConfig = {
    apiKey: "AIzaSyC0jloY1-k3bzz4HuPrmpL0wdtzHYMw-FE",
    databaseURL: "https://parking-bd6fa-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "parking-bd6fa"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  let isAdmin = false;
  let clickCount = 0;

  // ì„ì‹œê³µìœ  ëª¨ë‹¬ ëŒ€ìƒ ìŠ¬ë¡¯
  let shareSlotEl = null;

  // ---------------------------
  // ì´ˆê¸°í™”
  // ---------------------------
  function init() {
    createUnitList();
    renderMap();
    bindSlotClickHandlers();
    loadFromFirebase();
  }

  // ---------------------------
  // ì„¸ëŒ€ ë¦¬ìŠ¤íŠ¸ ìƒì„±
  // ---------------------------
  function createUnitList() {
    const skip = ['Aë™ 201í˜¸', 'Aë™ 202í˜¸', 'Aë™ 401í˜¸', 'Cë™ 202í˜¸', 'Cë™ 502í˜¸'];
    const fixed = ['Bë™ 302í˜¸', 'Cë™ 403í˜¸'];

    ['A','B','C'].forEach(dong => {
      const container = document.getElementById('list-' + dong);
      container.innerHTML = "";

      for (let f = 2; f <= 5; f++) {
        let rooms = (dong === 'B' && f > 3) || (dong === 'C' && f === 5) ? 2 : 3;

        for (let r = 1; r <= rooms; r++) {
          let name = `${dong}ë™ ${f}0${r}í˜¸`;
          let isChecked = !skip.includes(name) && !fixed.includes(name);

          container.innerHTML += `
            <div class="list-item">
              <label>
                <input type="checkbox" class="chk-draw" ${isChecked ? 'checked' : ''} value="${name}" data-dong="${dong}" disabled>
                ${f}0${r}í˜¸
              </label>
            </div>`;
        }
      }
    });
  }

  // ---------------------------
  // ì§€ë„ ë Œë”ë§
  // ---------------------------
  function renderMap() {
    const map = document.getElementById('mainMap');

    const makeRow = (layout, tag) => `<div class="parking-row">` + layout.map(t => {
      if (t === 'P') return `<div class="slot type-pillar">ê¸°ë‘¥</div>`;
      if (t === 'E') return `<div class="slot type-entrance">ğŸšª<br>ì¶œì…ë¬¸</div>`;

      // ì¥ì• ì¸(íŠ¹ìˆ˜) ìŠ¬ë¡¯: ì €ì¥/í‘œì‹œ ê°€ëŠ¥, ì¶”ì²¨ ëŒ€ìƒ ì•„ë‹˜
      if (t === 'D') {
        return `
          <div class="slot type-disabled"
               data-role="special"
               data-save="1"
               data-tag="${tag}">
            <strong class="slot-text">â™¿\nì¥ì• ì¸</strong>
          </div>`;
      }

      // ì¼ë°˜ ì£¼ì°¨ ìŠ¬ë¡¯: ì¶”ì²¨ ëŒ€ìƒ + ë¹„ì§€ì • í† ê¸€ + ì €ì¥ ê°€ëŠ¥
      return `
        <div class="slot"
             data-role="parking"
             data-save="1"
             data-tag="${tag}">
          <input type="checkbox" class="slot-toggle" checked onchange="updateStyle(this)">
          <strong class="slot-text">${tag}</strong>
        </div>`;
    }).join('') + `</div>`;

    map.innerHTML = `
      <div class="building-box">
        <div class="label">Aë™ í•„ë¡œí‹°</div>
        ${makeRow(['S','S','P','S','E','S','P','S'], 'A')}
        ${makeRow(['S','S','P','S','P','D'], 'A')}
      </div>

      <div class="joint-box">
        <div class="label joint-label">A-B ê³µë™</div>
        ${makeRow(['D','S'], 'AB')}
        ${makeRow(['S','S'], 'AB')}
      </div>

      <div class="building-box">
        <div class="label">Bë™ í•„ë¡œí‹°</div>
        ${makeRow(['S','S','E','S','S'], 'B')}
        ${makeRow(['S','S','P','S','P','S','S'], 'B')}
      </div>

      <div class="joint-box">
        <div class="label joint-label">B-C ê³µë™</div>
        ${makeRow(['S','S'], 'BC')}
        ${makeRow(['S','S'], 'BC')}
      </div>

      <div class="building-box">
        <div class="label">Cë™ í•„ë¡œí‹°</div>
        ${makeRow(['S','S','E','S','S'], 'C')}
        ${makeRow(['D','S','P','S','S'], 'C')}
      </div>
    `;
  }

  // ---------------------------
  // ê´€ë¦¬ì ë¡œê·¸ì¸
  // ---------------------------
  function handleAdminLogin() {
    if (++clickCount >= 5) {
      if (prompt("ë¹„ë°€ë²ˆí˜¸") === "1234") {
        isAdmin = true;
        document.getElementById('adminControls').style.display = 'block';
        document.getElementById('adminBadge').style.display = 'inline-block';
        document.getElementById('unitWrapper').style.display = 'flex';
        document.querySelectorAll('.chk-draw').forEach(el => el.disabled = false);
        document.querySelectorAll('.slot-toggle').forEach(el => el.style.display = 'block');
      }
      clickCount = 0;
    }
  }

  // ---------------------------
  // ìŠ¬ë¡¯ í´ë¦­ í•¸ë“¤ëŸ¬ ë°”ì¸ë”©
  //  - ì¼ë°˜ í´ë¦­: ëˆ„êµ¬ë‚˜ ì„ì‹œê³µìœ (ë‹¬ë ¥)
  //  - Shift+í´ë¦­: ê´€ë¦¬ì ìˆ˜ê¸°í‘œê¸°
  // ---------------------------
  function bindSlotClickHandlers() {
    document.querySelectorAll('.slot[data-save="1"]').forEach(slot => {
      slot.addEventListener('click', (e) => {
        // í† ê¸€ ì²´í¬ë°•ìŠ¤ í´ë¦­ì€ ì œì™¸(ë¹„ì§€ì • í† ê¸€ë¡œë§Œ ë™ì‘)
        if (e.target && e.target.classList.contains('slot-toggle')) return;

        // ì¼ë°˜ í´ë¦­: ì„ì‹œê³µìœ  ëª¨ë‹¬ (ëˆ„êµ¬ë‚˜)
        if (!e.shiftKey) {
          openShareModal(slot);
          return;
        }

        // Shift+í´ë¦­: ê´€ë¦¬ì ìˆ˜ê¸°í‘œê¸°
        if (!isAdmin) {
          alert("ìˆ˜ê¸°í‘œê¸°ëŠ” ê´€ë¦¬ìë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.\n(ì„ì‹œê³µìœ ëŠ” ê·¸ëƒ¥ í´ë¦­ìœ¼ë¡œ ì„¤ì •í•˜ì„¸ìš”.)");
          return;
        }
        openManualPrompt(slot);
      });
    });
  }

  // ---------------------------
  // (ê´€ë¦¬ì) ìˆ˜ê¸°í‘œê¸° ì…ë ¥
  // ---------------------------
  function openManualPrompt(slot) {
    const textEl = slot.querySelector('.slot-text');
    if (!textEl) return;

    const current = (slot.dataset.manualText ?? textEl.innerText).replace(/\n/g, ' ');
    const input = prompt(
      "í‘œê¸°í•  ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.\nì˜ˆ) Cë™ 403í˜¸ / ìì²˜ì‚¬ìš©(OOë‹˜)\n\në¹ˆì¹¸ìœ¼ë¡œ ë‘ë©´ 'ìˆ˜ê¸°í‘œê¸° í•´ì œ'",
      current
    );

    if (input === null) return;
    const trimmed = input.trim();

    if (trimmed === "") {
      // ìˆ˜ê¸°í‘œê¸° í•´ì œ
      delete slot.dataset.manualText;
      slot.classList.remove('manual-locked');

      // ìƒíƒœ ê¸°ë°˜ ê¸°ë³¸ í…ìŠ¤íŠ¸ ë³µêµ¬
      if (slot.dataset.role === 'parking') {
        if (slot.classList.contains('is-unassigned')) {
          textEl.innerText = baseWithShareText(slot, "ë¹„ì§€ì •");
        } else if (slot.classList.contains('filled')) {
          // filledëŠ” ê¸°ì¡´ í…ìŠ¤íŠ¸ ìœ ì§€(ì´ë¯¸ ì¶”ì²¨/ì €ì¥ í…ìŠ¤íŠ¸ê°€ ë“¤ì–´ìˆìŒ)
          applyShareBadge(slot); // share ë¬¸êµ¬ ì¬ì ìš©
        } else {
          textEl.innerText = baseWithShareText(slot, slot.dataset.tag);
        }
      } else {
        textEl.innerText = baseWithShareText(slot, "â™¿\nì¥ì• ì¸");
      }
      return;
    }

    // ìˆ˜ê¸°í‘œê¸° ì ìš©
    slot.dataset.manualText = trimmed;
    slot.classList.add('manual-locked');
    slot.classList.add('filled'); // ì‚¬ìš©ì¤‘ í‘œì‹œ(ì›ì¹˜ ì•Šìœ¼ë©´ ì‚­ì œ ê°€ëŠ¥)

    // í‘œì‹œ + share ë¬¸êµ¬ ìœ ì§€
    const base = trimmed.replace('ë™ ', 'ë™\n');
    const out = baseWithShareText(slot, base);
    textEl.innerText = out;
  }

  // ---------------------------
  // ìˆ˜ê¸°í‘œê¸° ì´ˆê¸°í™”(ì „ì²´)
  // ---------------------------
  function clearManualOverrides() {
    if (!isAdmin) {
      alert("ê´€ë¦¬ì ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.");
      return;
    }
    if (!confirm("ëª¨ë“  ì¹¸ì˜ 'ìˆ˜ê¸°í‘œê¸°'ë§Œ ì´ˆê¸°í™”í• ê¹Œìš”?\n(ì¶”ì²¨ ê²°ê³¼/ë¹„ì§€ì •/ì„ì‹œê³µìœ ëŠ” ìœ ì§€ë©ë‹ˆë‹¤)")) return;

    document.querySelectorAll('.slot[data-save="1"]').forEach(slot => {
      if (!slot.dataset.manualText) return;

      delete slot.dataset.manualText;
      slot.classList.remove('manual-locked');

      const textEl = slot.querySelector('.slot-text');
      if (!textEl) return;

      // ê¸°ë³¸ í…ìŠ¤íŠ¸ ë³µêµ¬(í˜„ì¬ ìƒíƒœ ê¸°ì¤€) + share ë¬¸êµ¬ ì¬ì ìš©
      let base;
      if (slot.dataset.role === "parking") {
        if (slot.classList.contains('is-unassigned')) base = "ë¹„ì§€ì •";
        else if (slot.classList.contains('filled')) base = textEl.innerText.replace(/\n?ğŸŸ¢ ì„ì‹œê³µìœ .*$/m, "").trim(); // í˜„ì¬ í‘œì‹œ ìœ ì§€
        else base = slot.dataset.tag;
      } else {
        base = "â™¿\nì¥ì• ì¸";
      }
      textEl.innerText = baseWithShareText(slot, base);
    });

    alert("ìˆ˜ê¸°í‘œê¸°ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.\nì›í•˜ì‹œë©´ 'ì„œë²„ì— ê²°ê³¼ ì €ì¥'ì„ ëˆŒëŸ¬ ë°˜ì˜í•˜ì„¸ìš”.");
  }

  // ---------------------------
  // ì¶”ì²¨ ë¡œì§
  // ---------------------------
  function executeDraw() {
    const getApps = (dong) => Array.from(document.querySelectorAll(`.chk-draw[data-dong="${dong}"]:checked`))
      .map(e => e.value).sort(() => Math.random() - 0.5);

    let appsA = getApps('A');
    let appsB = getApps('B');
    let appsC = getApps('C');

    const getSlots = (tag) => Array.from(document.querySelectorAll(`.slot[data-role="parking"][data-tag="${tag}"]`))
      .filter(s => !s.classList.contains('is-unassigned'));

    let slotsA  = getSlots('A');
    let slotsB  = getSlots('B');
    let slotsC  = getSlots('C');
    let slotsAB = getSlots('AB');
    let slotsBC = getSlots('BC');

    // ì´ˆê¸°í™”: ìˆ˜ê¸°í‘œê¸°(ì ê¸ˆ) ì¹¸ì€ ê±´ë“œë¦¬ì§€ ì•ŠìŒ
    document.querySelectorAll('.slot[data-role="parking"]').forEach(s => {
      const locked = (s.dataset.manualText && s.dataset.manualText.trim() !== "");
      if (locked) {
        s.classList.add('filled');
        applyShareBadge(s);
        return;
      }
      const textEl = s.querySelector('.slot-text');
      if (!textEl) return;
      s.classList.remove('filled');

      // ë¹„ì§€ì •ì´ë©´ "ë¹„ì§€ì •", ì•„ë‹ˆë©´ tag
      const base = s.classList.contains('is-unassigned') ? "ë¹„ì§€ì •" : s.dataset.tag;
      textEl.innerText = baseWithShareText(s, base);
    });

    let losers = [];

    const fillDirect = (apps, slots) => {
      while (apps.length > 0 && slots.length > 0) {
        let s = slots.shift();

        while (s && s.dataset.manualText && s.dataset.manualText.trim() !== "") {
          s = slots.shift();
        }
        if (!s) break;

        let p = apps.shift();
        const textEl = s.querySelector('.slot-text');
        if (!textEl) continue;

        const base = p.replace('ë™ ', 'ë™\n');
        textEl.innerText = baseWithShareText(s, base);
        s.classList.add('filled');
      }
    };

    fillDirect(appsA, slotsA);
    fillDirect(appsB, slotsB);
    fillDirect(appsC, slotsC);

    fillDirect(appsA, slotsAB);
    fillDirect(appsB, slotsAB);

    fillDirect(appsC, slotsBC);
    fillDirect(appsB, slotsBC);

    losers = [...appsA, ...appsB, ...appsC];

    const sArea = document.getElementById('summaryArea');
    sArea.style.display = 'block';
    sArea.innerHTML =
      `<h3>ğŸ“Š êµ¬ì—­ë³„ ì¶”ì²¨ ê²°ê³¼</h3>` +
      `<p>â€¢ ë‹¹ì²¨/í‘œê¸° ì¹¸ ìˆ˜: ${document.querySelectorAll('.slot.filled').length} ì¹¸</p>` +
      (losers.length ? `<div style="color:red; font-weight:bold; margin-top:10px;">âš ï¸ ëŒ€ê¸° ìˆœë²ˆ: ${losers.join(', ')}</div>` : "");
  }

  // ---------------------------
  // ë¹„ì§€ì • í† ê¸€
  // ---------------------------
  function updateStyle(c) {
    const s = c.closest('.slot');
    if (!s) return;

    const textEl = s.querySelector('.slot-text');
    if (!textEl) return;

    if (c.checked) {
      s.classList.remove('is-unassigned');
      // ìˆ˜ê¸°í‘œê¸° ìˆìœ¼ë©´ ê·¸ëŒ€ë¡œ
      if (s.dataset.manualText && s.dataset.manualText.trim() !== "") {
        const base = s.dataset.manualText.replace('ë™ ', 'ë™\n');
        textEl.innerText = baseWithShareText(s, base);
      } else if (s.classList.contains('filled')) {
        // filledë©´ í˜„ì¬ í…ìŠ¤íŠ¸ ìœ ì§€(shareë§Œ ì¬ì ìš©)
        applyShareBadge(s);
      } else {
        textEl.innerText = baseWithShareText(s, s.dataset.tag);
      }
    } else {
      s.classList.add('is-unassigned');
      if (s.dataset.manualText && s.dataset.manualText.trim() !== "") {
        const base = s.dataset.manualText.replace('ë™ ', 'ë™\n');
        textEl.innerText = baseWithShareText(s, base);
      } else {
        textEl.innerText = baseWithShareText(s, "ë¹„ì§€ì •");
      }
    }
  }

  // ---------------------------
  // ì„œë²„ ì €ì¥ / ì´ˆê¸°í™” / ë¡œë“œ
  // ---------------------------
  function saveToFirebase() {
    if (!isAdmin) {
      alert("ê´€ë¦¬ì ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.");
      return;
    }
    if (!confirm("ì´ ê²°ê³¼ë¥¼ ì„œë²„ì— ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

    const slotsData = Array.from(document.querySelectorAll('.slot[data-save="1"]')).map(s => ({
      text: s.querySelector('.slot-text') ? s.querySelector('.slot-text').innerText : "",
      filled: s.classList.contains('filled'),
      un: s.classList.contains('is-unassigned'),
      tag: s.dataset.tag,
      role: s.dataset.role || "",
      manualText: s.dataset.manualText || "",
      shareFrom: s.dataset.shareFrom || "",
      shareTo: s.dataset.shareTo || ""
    }));

    db.ref('parking_result').set({
      slots: slotsData,
      report: document.getElementById('summaryArea').innerHTML
    })
    .then(() => alert("ì„œë²„ ì €ì¥ ì™„ë£Œ!"))
    .catch((error) => alert("ì €ì¥ ì‹¤íŒ¨: " + error.message));
  }

  function resetDatabase() {
    if (!isAdmin) {
      alert("ê´€ë¦¬ì ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.");
      return;
    }
    if (!confirm("ì •ë§ë¡œ ëª¨ë“  ë°ì´í„°ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

    db.ref('parking_result').remove().then(() => {
      alert("ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.");
      location.reload();
    }).catch((error) => alert("ì´ˆê¸°í™” ì‹¤íŒ¨: " + error.message));
  }

  function loadFromFirebase() {
    db.ref('parking_result').on('value', s => {
      const d = s.val();
      const slots = document.querySelectorAll('.slot[data-save="1"]');

      if (d && d.slots) {
        d.slots.forEach((item, i) => {
          const slot = slots[i];
          if (!slot) return;

          const textEl = slot.querySelector('.slot-text');

          // ìƒíƒœ
          if (item.filled) slot.classList.add('filled'); else slot.classList.remove('filled');
          if (item.un) slot.classList.add('is-unassigned'); else slot.classList.remove('is-unassigned');

          // ì„ì‹œê³µìœ 
          if (item.shareFrom) slot.dataset.shareFrom = item.shareFrom; else delete slot.dataset.shareFrom;
          if (item.shareTo) slot.dataset.shareTo = item.shareTo; else delete slot.dataset.shareTo;

          // ìˆ˜ê¸°í‘œê¸° ìš°ì„ 
          if (item.manualText && item.manualText.trim() !== "") {
            slot.dataset.manualText = item.manualText;
            slot.classList.add('manual-locked');
            slot.classList.add('filled');

            const base = item.manualText.replace('ë™ ', 'ë™\n');
            if (textEl) textEl.innerText = baseWithShareText(slot, base);
          } else {
            delete slot.dataset.manualText;
            slot.classList.remove('manual-locked');

            if (textEl) {
              // ì„œë²„ì— ì €ì¥ëœ textë¥¼ ê¸°ë³¸ìœ¼ë¡œ ì‚¬ìš©í•˜ë˜, share ë¬¸êµ¬ëŠ” ìš°ë¦¬ê°€ ì¬ì ìš©
              const base = (item.text || "").replace(/\n?ğŸŸ¢ ì„ì‹œê³µìœ .*$/m, "").trim();
              const fallback = base || (slot.dataset.role === "special" ? "â™¿\nì¥ì• ì¸" : (slot.classList.contains('is-unassigned') ? "ë¹„ì§€ì •" : slot.dataset.tag));
              textEl.innerText = baseWithShareText(slot, fallback);
            }
          }

          // share í…Œë‘ë¦¬ ì ìš©
          applyShareBadge(slot);
        });

        if (d.report) {
          document.getElementById('summaryArea').innerHTML = d.report;
          document.getElementById('summaryArea').style.display = 'block';
        }

        if (!isAdmin) document.getElementById('unitWrapper').style.display = 'none';
      }
    });
  }

  // ---------------------------
  // ì´ë¯¸ì§€ ì €ì¥
  // ---------------------------
  function saveAsImage() {
    html2canvas(document.getElementById('printArea'), { scale: 2 }).then(canvas => {
      const a = document.createElement('a');
      a.download = 'parking_map.png';
      a.href = canvas.toDataURL();
      a.click();
    });
  }

  // ---------------------------
  // ì„ì‹œê³µìœ : ëª¨ë‹¬ + í‘œì‹œ
  // ---------------------------
  function fmtMD(ymd) {
    if (!ymd || !/^\d{4}-\d{2}-\d{2}$/.test(ymd)) return "";
    const [, m, d] = ymd.split("-");
    return `${parseInt(m,10)}/${parseInt(d,10)}`;
  }

  function openShareModal(slot) {
    shareSlotEl = slot;

    const textEl = slot.querySelector('.slot-text');
    const base = (textEl ? textEl.innerText.replace(/\n/g, ' ') : (slot.dataset.tag || "")).trim();
    document.getElementById('shareTarget').innerText = `ëŒ€ìƒ ì¹¸: ${base || (slot.dataset.tag || "")}`;

    const from = slot.dataset.shareFrom || "";
    const to = slot.dataset.shareTo || "";
    document.getElementById('shareFrom').value = from;
    document.getElementById('shareTo').value = to;
    document.getElementById('shareOneDay').checked = (from && to && from === to);

    document.getElementById('shareModal').style.display = 'block';
  }

  function closeShareModal() {
    document.getElementById('shareModal').style.display = 'none';
    shareSlotEl = null;
  }

  document.addEventListener('change', (e) => {
    if (e.target && e.target.id === 'shareOneDay') {
      const fromEl = document.getElementById('shareFrom');
      const toEl = document.getElementById('shareTo');
      if (e.target.checked && fromEl.value) toEl.value = fromEl.value;
    }
    if (e.target && e.target.id === 'shareFrom') {
      const oneDay = document.getElementById('shareOneDay');
      const toEl = document.getElementById('shareTo');
      if (oneDay.checked && e.target.value) toEl.value = e.target.value;
    }
  });

  function saveShareRange() {
    if (!shareSlotEl) return;

    const from = document.getElementById('shareFrom').value;
    const to = document.getElementById('shareTo').value;

    if (!from || !to) { alert("ì‹œì‘ì¼ê³¼ ì¢…ë£Œì¼ì„ ëª¨ë‘ ì„ íƒí•´ì£¼ì„¸ìš”."); return; }
    if (to < from) { alert("ì¢…ë£Œì¼ì€ ì‹œì‘ì¼ë³´ë‹¤ ë¹ ë¥¼ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); return; }

    shareSlotEl.dataset.shareFrom = from;
    shareSlotEl.dataset.shareTo = to;

    applyShareBadge(shareSlotEl);
    closeShareModal();
  }

  function clearShareRange() {
    if (!shareSlotEl) return;
    delete shareSlotEl.dataset.shareFrom;
    delete shareSlotEl.dataset.shareTo;

    applyShareBadge(shareSlotEl);
    closeShareModal();
  }

  function applyShareBadge(slot) {
    const from = slot.dataset.shareFrom || "";
    const to = slot.dataset.shareTo || "";

    if (from && to) slot.classList.add('share-on');
    else slot.classList.remove('share-on');

    // í…ìŠ¤íŠ¸ì— "ì„ì‹œê³µìœ " ë¼ì¸ ë¶™ì´ê¸°
    const textEl = slot.querySelector('.slot-text');
    if (!textEl) return;

    // base í…ìŠ¤íŠ¸ëŠ” "ìˆ˜ê¸°í‘œê¸° > í˜„ì¬ í…ìŠ¤íŠ¸ > ê¸°ë³¸ê°’" ìˆœ
    let base = "";
    if (slot.dataset.manualText && slot.dataset.manualText.trim() !== "") {
      base = slot.dataset.manualText.replace('ë™ ', 'ë™\n');
    } else {
      base = textEl.innerText.replace(/\n?ğŸŸ¢ ì„ì‹œê³µìœ .*$/m, "").trim();
      if (!base) {
        if (slot.dataset.role === "special") base = "â™¿\nì¥ì• ì¸";
        else if (slot.classList.contains('is-unassigned')) base = "ë¹„ì§€ì •";
        else base = slot.dataset.tag;
      }
    }

    textEl.innerText = baseWithShareText(slot, base);
  }

  function baseWithShareText(slot, baseText) {
    const from = slot.dataset.shareFrom || "";
    const to = slot.dataset.shareTo || "";

    // ê¸°ì¡´ ì„ì‹œê³µìœ  ë¼ì¸ ì œê±° í›„ baseë§Œ ë‚¨ê¸°ê¸°
    let clean = (baseText || "").toString().replace(/\n?ğŸŸ¢ ì„ì‹œê³µìœ .*$/m, "").trim();

    if (from && to) {
      const range = (from === to) ? `${fmtMD(from)} í•˜ë£¨` : `${fmtMD(from)}~${fmtMD(to)}`;
      return `${clean}\nğŸŸ¢ ì„ì‹œê³µìœ (${range})`;
    }
    return clean;
  }

  init();
</script>
</body>
</html>
