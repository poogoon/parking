<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>í¸ë°±ë‚˜ë¬´ ì£¼ì°¨ ë°°ì • ì‹œìŠ¤í…œ</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root { --primary: #34495e; --accent: #3182ce; --danger: #e53e3e; --joint-bg: #f8fafc; }
        body { font-family: 'Apple SD Gothic Neo', sans-serif; background-color: #f4f7f9; margin: 0; padding: 15px; color: #333; }
        
        .container { max-width: 800px; margin: auto; background: white; padding: 20px; border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.05); }
        h1 { margin: 0 0 10px 0; font-size: 1.4rem; text-align: center; color: var(--primary); cursor: pointer;}
        
        /* ì„¸ëŒ€ ëª…ë‹¨ (ê´€ë¦¬ììš© - í‰ì†Œ ìˆ¨ê¹€) */
        .dong-wrapper { display: none; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .dong-column { flex: 1; min-width: 120px; background: #fff; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 12px; }
        .list-item { border-bottom: 1px solid #eee; padding: 2px 0; }
        
        /* ë§µ ì„¹ì…˜ */
        .map-section { display: flex; flex-direction: column; gap: 25px; align-items: center; margin-top: 20px; }

        /* êµ¬ì—­ ë°•ìŠ¤ (ì œëª© ë¬¸ì œ ìˆ˜ì •ë¨) */
        .zone-container {
            width: 100%;
            max-width: 600px;
            padding: 20px 10px; /* ë‚´ë¶€ ì—¬ë°± í™•ë³´ */
            border-radius: 12px;
            box-sizing: border-box;
            background: #fff;
            display: flex;
            flex-direction: column;
            align-items: center; /* ë‚´ë¶€ ìš”ì†Œ ê°€ìš´ë° ì •ë ¬ */
            
            /* ëª¨ë°”ì¼ ëŒ€ì‘ */
            overflow-x: auto; 
            -webkit-overflow-scrolling: touch;
        }

        .style-building { border: 2px solid var(--primary); }
        .style-joint { border: 2px dashed var(--accent); background-color: var(--joint-bg); }

        /* ì œëª© (ì ˆëŒ€ìœ„ì¹˜ ì œê±° -> ë¸”ë¡ ìš”ì†Œë¡œ ë³€ê²½) */
        .zone-title-badge {
            background: var(--primary);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: bold;
            margin-bottom: 15px; /* ì œëª©ê³¼ ì£¼ì°¨ì¹¸ ì‚¬ì´ ê°„ê²© */
            display: inline-block;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .style-joint .zone-title-badge { background: var(--accent); }

        /* ì£¼ì°¨ì¹¸ ë˜í¼ */
        .slots-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: max-content; /* ë‚´ìš©ë¬¼ ì°Œê·¸ëŸ¬ì§ ë°©ì§€ */
        }

        .parking-row { display: flex; gap: 6px; margin-bottom: 6px; justify-content: center; }

        .slot {
            width: 65px; height: 85px;
            border: 1px solid #cbd5e0; border-radius: 5px;
            background: #fff;
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            font-size: 12px; text-align: center;
            position: relative;
            box-shadow: 1px 1px 3px rgba(0,0,0,0.1);
        }

        .slot.filled { background-color: #ebf8ff; border: 2px solid var(--accent); color: var(--accent); font-weight: bold; }
        .slot.is-unassigned { border: 2px dashed #cbd5e0; background: #f8fafc; color: #aaa; }
        
        .type-pillar { background: #95a5a6; border: none; width: 30px; box-shadow: none; color: transparent; } 
        .type-pillar::after { content:''; width:8px; height:8px; background:#bdc3c7; border-radius:50%; }
        .type-entrance { background: #3182ce; color: white; border: none; font-weight: bold; width: 70px; }
        .type-disabled { background: #2c5282; color: white; border: none; font-weight: bold; }

        .slot-toggle { position: absolute; top: 2px; left: 2px; transform: scale(0.9); z-index: 10; display: none; }

        #adminControls { display: none; margin-top: 30px; padding: 15px; background: #fff5f5; border: 1px solid var(--danger); border-radius: 10px; }
        .btn { padding: 10px 15px; border: none; border-radius: 5px; color: white; font-weight: bold; cursor: pointer; margin: 5px; font-size: 14px; }
        .btn-draw { background: var(--primary); }
        .btn-save { background: #2f855a; }
        .btn-reset { background: var(--danger); }
        .btn-img { background: #718096; display: block; width: 100%; margin-top: 10px; }
        #summaryArea { display:none; background:#edf2f7; padding:15px; margin-bottom:20px; border-radius:8px; text-align:left; font-size:13px; line-height:1.6; border-left: 4px solid var(--primary); }
    </style>
</head>
<body>

<div class="container">
    <h1 onclick="handleAdminLogin()">ğŸš™ í¸ë°±ë‚˜ë¬´ ì£¼ì°¨ ë°°ì •</h1>
    <div id="adminModeMsg" style="display:none; text-align:center; color:red; font-size:12px; font-weight:bold;">ê´€ë¦¬ì ëª¨ë“œ í™œì„±</div>

    <div id="unitWrapper" class="dong-wrapper">
        <div class="dong-column"><strong>Aë™</strong><div id="list-A"></div></div>
        <div class="dong-column"><strong>Bë™</strong><div id="list-B"></div></div>
        <div class="dong-column"><strong>Cë™</strong><div id="list-C"></div></div>
    </div>

    <div id="printArea">
        <div id="summaryArea"></div>

        <div class="map-section">
            
            <div class="zone-container style-building">
                <div class="zone-title-badge">Aë™ í•„ë¡œí‹°</div>
                <div class="slots-wrapper" id="zone-A"></div>
            </div>

            <div class="zone-container style-joint">
                <div class="zone-title-badge">A-B ì‚¬ì´ ê³µë™</div>
                <div class="slots-wrapper" id="zone-AB"></div>
            </div>

            <div class="zone-container style-building">
                <div class="zone-title-badge">Bë™ í•„ë¡œí‹°</div>
                <div class="slots-wrapper" id="zone-B"></div>
            </div>

            <div class="zone-container style-joint">
                <div class="zone-title-badge">B-C ì‚¬ì´ ê³µë™</div>
                <div class="slots-wrapper" id="zone-BC"></div>
            </div>

            <div class="zone-container style-building">
                <div class="zone-title-badge">Cë™ í•„ë¡œí‹°</div>
                <div class="slots-wrapper" id="zone-C"></div>
            </div>

        </div>
    </div>

    <div id="adminControls">
        <h3 style="margin:0 0 10px 0;">âš™ï¸ ê´€ë¦¬ì ì œì–´íŒ</h3>
        <div style="display:flex; justify-content:center; flex-wrap:wrap;">
            <button class="btn btn-draw" onclick="executeDraw()">ğŸ² ì¶”ì²¨ ì‹¤í–‰</button>
            <button class="btn btn-save" onclick="saveData()">ğŸ’¾ ê²°ê³¼ ì €ì¥</button>
            <button class="btn btn-reset" onclick="resetData()">ğŸ§¹ ì´ˆê¸°í™”</button>
        </div>
        <button class="btn btn-img" onclick="saveImage()">ğŸ“¸ ì´ë¯¸ì§€ ì €ì¥</button>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyC0jloY1-k3bzz4HuPrmpL0wdtzHYMw-FE",
        databaseURL: "https://parking-bd6fa-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "parking-bd6fa"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const skipList = ['Aë™ 201í˜¸', 'Aë™ 202í˜¸', 'Aë™ 401í˜¸', 'Cë™ 202í˜¸', 'Cë™ 502í˜¸'];
    const fixedList = { 'Cë™ 403í˜¸': 'Cë™ ì¥ì• ì¸' }; 
    let isAdmin = false;
    let clickCount = 0;

    function init() {
        createUnitList();
        renderAllZones();
        loadData(); // ì„œë²„ ë°ì´í„° ë¡œë“œ
    }

    // ëª…ë‹¨ ìƒì„±
    function createUnitList() {
        ['A','B','C'].forEach(dong => {
            const container = document.getElementById(`list-${dong}`);
            container.innerHTML = "";
            for(let f=2; f<=5; f++){
                let rooms = (dong === 'B' && f > 3) || (dong === 'C' && f === 5) ? 2 : 3;
                for(let r=1; r<=rooms; r++){
                    const name = `${dong}ë™ ${f}0${r}í˜¸`;
                    let isSkipped = skipList.includes(name);
                    let isFixed = fixedList[name];
                    let label = name;
                    let disabled = 'disabled';
                    let checked = (!isSkipped && !isFixed) ? 'checked' : '';
                    
                    if(isSkipped) label += " <span style='color:#ccc'>(x)</span>";
                    if(isFixed) label += " <span style='color:blue'>(ê³ ì •)</span>";

                    container.innerHTML += `<div class="list-item"><label><input type="checkbox" class="chk-unit" value="${name}" data-dong="${dong}" ${checked} ${disabled}> ${label}</label></div>`;
                }
            }
        });
    }

    // ë§µ ê·¸ë¦¬ê¸° (íƒ€ì´í‹€ì€ HTMLì— ë°•ìŒ)
    function renderAllZones() {
        const makeRow = (arr, zone) => {
            return `<div class="parking-row">` + arr.map(type => {
                if(type === 'P') return `<div class="slot type-pillar"></div>`;
                if(type === 'E') return `<div class="slot type-entrance">ì¶œì…êµ¬</div>`;
                if(type === 'D') {
                    const txt = zone === 'C' ? 'Cì¥ì• ì¸\n(403í˜¸)' : 'ì¥ì• ì¸';
                    return `<div class="slot type-disabled">${txt}</div>`;
                }
                return `<div class="slot" data-role="parking" data-zone="${zone}">
                            <input type="checkbox" class="slot-toggle" checked onchange="toggleSlot(this)">
                            <span class="slot-txt">${zone}</span>
                        </div>`;
            }).join('') + `</div>`;
        };

        // Aë™
        document.getElementById('zone-A').innerHTML = 
            makeRow(['S','S','P','S','E','S','P','S'], 'A') + 
            makeRow(['S','S','P','S','P','D'], 'A');
        // AB ê³µë™
        document.getElementById('zone-AB').innerHTML = 
            makeRow(['D','S'], 'AB') + makeRow(['S','S'], 'AB');
        // Bë™
        document.getElementById('zone-B').innerHTML = 
            makeRow(['S','S','E','S','S'], 'B') + 
            makeRow(['S','S','P','S','P','S','S'], 'B');
        // BC ê³µë™
        document.getElementById('zone-BC').innerHTML = 
            makeRow(['S','S'], 'BC') + makeRow(['S','S'], 'BC');
        // Cë™
        document.getElementById('zone-C').innerHTML = 
            makeRow(['S','S','E','S','S'], 'C') + 
            makeRow(['D','P','S','S'], 'C');
    }

    // ì¶”ì²¨ ë¡œì§
    function executeDraw() {
        if(!confirm("ê¸°ì¡´ ë°°ì •ì„ ì§€ìš°ê³  ìƒˆë¡œ ì¶”ì²¨í•©ë‹ˆë‹¤.")) return;
        
        const applicants = Array.from(document.querySelectorAll('.chk-unit:checked')).map(el => ({name: el.value, dong: el.dataset.dong}));
        const getSlots = (z) => Array.from(document.querySelectorAll(`.slot[data-zone="${z}"]:not(.is-unassigned)`));
        
        if(!applicants.length) return alert("ëŒ€ìƒìê°€ ì—†ìŠµë‹ˆë‹¤.");

        // ìŠ¬ë¡¯ ì´ˆê¸°í™”
        document.querySelectorAll('.slot[data-role="parking"]').forEach(s => {
            if(!s.classList.contains('is-unassigned')) {
                s.classList.remove('filled');
                s.querySelector('.slot-txt').innerText = s.dataset.zone;
            }
        });

        // ì„ê¸°
        const shuffle = arr => arr.sort(() => Math.random() - 0.5);
        let gA = shuffle(applicants.filter(p => p.dong === 'A'));
        let gB = shuffle(applicants.filter(p => p.dong === 'B'));
        let gC = shuffle(applicants.filter(p => p.dong === 'C'));

        function assign(people, slots) {
            let win = [], lose = [];
            if(people.length <= slots.length) win = people;
            else { win = people.slice(0, slots.length); lose = people.slice(slots.length); }
            
            win.forEach((p, i) => {
                slots[i].classList.add('filled');
                slots[i].querySelector('.slot-txt').innerText = p.name.replace('ë™ ', '\n');
            });
            return { win, lose };
        }

        // 1ì°¨ ë°°ì •
        let resA = assign(gA, getSlots('A'));
        let resB = assign(gB, getSlots('B'));
        let resC = assign(gC, getSlots('C'));

        // 2ì°¨ ë°°ì •
        let poolAB = shuffle([...resA.lose, ...resB.lose]);
        let resAB = assign(poolAB, getSlots('AB'));

        let failedFromAB_B = resAB.lose.filter(p => p.dong === 'B');
        let failedFromAB_A = resAB.lose.filter(p => p.dong === 'A');

        let poolBC = shuffle([...failedFromAB_B, ...resC.lose]);
        let resBC = assign(poolBC, getSlots('BC'));

        const finalLose = [...failedFromAB_A, ...resBC.lose];
        const totalWin = applicants.length - finalLose.length;

        // ë¦¬í¬íŠ¸
        const summary = document.getElementById('summaryArea');
        summary.innerHTML = `
            <strong>ğŸ“Š ê²°ê³¼ ë¦¬í¬íŠ¸</strong><br>
            â€¢ ë‹¹ì²¨: ${totalWin}ì„¸ëŒ€ / ì‹ ì²­: ${applicants.length}<br>
            â€¢ ë¯¸ë°°ì •: ${finalLose.length > 0 ? `<span style="color:red">${finalLose.map(p=>p.name).join(', ')}</span>` : 'ì—†ìŒ (ì „ì› ë‹¹ì²¨)'}
        `;
        summary.style.display = 'block';
    }

    // â˜… ë°ì´í„° ë¡œë“œ ìˆ˜ì • (ë¹„ì§€ì • ìƒíƒœê°€ UI ì²´í¬ë°•ìŠ¤ì—ë„ ë°˜ì˜ë˜ë„ë¡) â˜…
    function loadData() {
        db.ref('parking_v3').on('value', snap => {
            const d = snap.val();
            if(!d) return;
            
            const slots = document.querySelectorAll('.slot[data-role="parking"]');
            if(d.map) {
                d.map.forEach((item, i) => {
                    if(slots[i]) {
                        const s = slots[i];
                        const chk = s.querySelector('.slot-toggle');
                        
                        // í…ìŠ¤íŠ¸ ë³µêµ¬
                        s.querySelector('.slot-txt').innerText = item.txt;
                        
                        // ë°°ì • ìƒíƒœ(ìƒ‰ìƒ) ë³µêµ¬
                        if(item.filled) s.classList.add('filled');
                        else s.classList.remove('filled');
                        
                        // â˜… ë¹„ì§€ì • ìƒíƒœ ë° ì²´í¬ë°•ìŠ¤ ë™ê¸°í™” ë³µêµ¬ â˜…
                        if(item.unassigned) {
                            s.classList.add('is-unassigned');
                            if(chk) chk.checked = false; // ì²´í¬ë°•ìŠ¤ ë„ê¸°
                        } else {
                            s.classList.remove('is-unassigned');
                            if(chk) chk.checked = true; // ì²´í¬ë°•ìŠ¤ ì¼œê¸°
                        }
                    }
                });
            }
            if(d.report) {
                document.getElementById('summaryArea').innerHTML = d.report;
                document.getElementById('summaryArea').style.display = 'block';
            }
        });
    }

    function saveData() {
        if(!isAdmin) return alert("ê´€ë¦¬ìë§Œ ì €ì¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
        if(!confirm("ì„œë²„ì— ì €ì¥í•©ë‹ˆê¹Œ?")) return;
        const data = [];
        document.querySelectorAll('.slot[data-role="parking"]').forEach(s => {
            data.push({
                zone: s.dataset.zone,
                txt: s.querySelector('.slot-txt').innerText,
                filled: s.classList.contains('filled'),
                unassigned: s.classList.contains('is-unassigned')
            });
        });
        db.ref('parking_v3').set({
            map: data, 
            report: document.getElementById('summaryArea').innerHTML
        }).then(() => alert("ì €ì¥ ì™„ë£Œ"));
    }

    function resetData() {
        if(!isAdmin) return;
        if(confirm("ì •ë§ ì´ˆê¸°í™” í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
            db.ref('parking_v3').remove();
            location.reload();
        }
    }

    function toggleSlot(chk) {
        const s = chk.closest('.slot');
        if(chk.checked) {
            s.classList.remove('is-unassigned');
            // ë°°ì •ëœ ìƒíƒœì˜€ë‹¤ë©´ í…ìŠ¤íŠ¸ ìœ ì§€ê°€ ì• ë§¤í•˜ë¯€ë¡œ êµ¬ì—­ëª…ìœ¼ë¡œ ë¦¬ì…‹ or ê¸°ì¡´ í…ìŠ¤íŠ¸ ìœ ì§€
            if(s.querySelector('.slot-txt').innerText === "ë¹„ì§€ì •") {
                s.querySelector('.slot-txt').innerText = s.dataset.zone;
            }
        } else {
            s.classList.add('is-unassigned');
            s.querySelector('.slot-txt').innerText = "ë¹„ì§€ì •";
            s.classList.remove('filled'); // ë¹„ì§€ì •í•˜ë©´ ë‹¹ì²¨ë„ ì·¨ì†Œ
        }
    }

    function handleAdminLogin() {
        clickCount++;
        if(clickCount >= 5) {
            if(prompt("ê´€ë¦¬ì ì•”í˜¸") === "1234") {
                isAdmin = true;
                document.getElementById('adminControls').style.display = 'block';
                document.getElementById('unitWrapper').style.display = 'flex';
                document.getElementById('adminModeMsg').style.display = 'block';
                document.querySelectorAll('.chk-unit').forEach(e => e.disabled = false);
                document.querySelectorAll('.slot-toggle').forEach(e => e.style.display = 'block');
            }
            clickCount = 0;
        }
    }

    function saveImage() {
        window.scrollTo(0,0);
        html2canvas(document.getElementById('printArea'), {scale: 2}).then(canvas => {
            const a = document.createElement('a');
            a.download = 'ì£¼ì°¨ë°°ì •ê²°ê³¼.png';
            a.href = canvas.toDataURL();
            a.click();
        });
    }

    init();
</script>
</body>
</html>
