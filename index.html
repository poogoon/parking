<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>편백나무 주차 관리 시스템</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root { --primary: #34495e; --accent: #3182ce; --danger: #e53e3e; --joint: #f8fafc; }
        body { font-family: 'Apple SD Gothic Neo', sans-serif; text-align: center; background-color: #f4f7f9; margin: 0; padding: 20px; color: #333; }
        .container { max-width: 1100px; margin: auto; background: white; padding: 30px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        h1 { cursor: pointer; user-select: none; margin-bottom: 5px; padding: 10px; }
        .admin-badge { display: none; color: #3182ce; font-size: 14px; font-weight: bold; border: 1px solid #3182ce; padding: 2px 10px; border-radius: 20px; margin: 10px 0; }
        .summary-box { display: none; background: #fff; border: 3px solid var(--accent); padding: 25px; border-radius: 15px; margin: 20px 0 40px 0; text-align: left; line-height: 1.6; }
        .dong-wrapper { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 30px; }
        .dong-column { flex: 1; min-width: 300px; background: #fff; padding: 15px; border-radius: 12px; border: 1px solid #e2e8f0; }
        .dong-title { font-weight: bold; margin-bottom: 10px; padding: 8px; background: #f8fafc; border-radius: 6px; border-bottom: 2px solid var(--primary); }
        .list-item { display: flex; align-items: center; justify-content: space-between; margin-bottom: 5px; font-size: 13px; padding: 4px 10px; border-radius: 4px; border: 1px solid #f1f5f9; }
        .map-section { margin: 20px 0; padding: 20px; background: #fdfdfd; border: 1px solid #cbd5e0; border-radius: 15px; }
        .map-container { display: flex; flex-direction: column; gap: 15px; align-items: center; }
        .building-box { width: 100%; border: 2px solid var(--primary); border-radius: 10px; padding: 45px 15px 20px; position: relative; background: white; box-sizing: border-box; margin-bottom: 20px; }
        .joint-box { width: 100%; border: 1px dashed var(--accent); border-radius: 10px; padding: 25px 15px 15px; position: relative; background: var(--joint); box-sizing: border-box; margin-bottom: 20px; }
        .label { position: absolute; top: -13px; left: 20px; padding: 3px 15px; font-size: 12px; border-radius: 4px; font-weight: bold; background: var(--primary); color: white; }
        .joint-label { background: var(--accent); }
        .parking-row { display: flex; justify-content: center; gap: 8px; margin: 8px 0; flex-wrap: wrap; }
        .slot { width: 85px; height: 110px; border: 1px solid #dcdde1; border-radius: 6px; position: relative; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 12px; background: #fff; white-space: pre-line; line-height: 1.3; }
        .slot-toggle { position: absolute; top: 6px; left: 6px; transform: scale(1.3); cursor: pointer; z-index: 20; display: none; }
        .slot.filled { background-color: #ebf8ff !important; border: 2px solid var(--accent) !important; color: var(--primary) !important; font-weight: bold; }
        .slot.is-unassigned { background-color: #f1f5f9 !important; border: 2px dashed #cbd5e0 !important; color: #94a3b8 !important; }
        .type-pillar { width: 40px; background: #95a5a6; color: white; border: none; }
        .type-entrance { width: 100px; background: #3182ce; color: white; border: none; font-weight: bold; font-size: 11px; }
        .type-disabled { background-color: #2b6cb0; color: white; border: none; font-weight: bold; }
        #adminControls { display: none; margin: 20px 0; padding: 20px; background: #fef2f2; border-radius: 10px; border: 2px solid var(--danger); }
        .btn { padding: 12px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 15px; margin: 5px; transition: 0.2s; }
        .draw-btn { background: var(--primary); color: white; }
        .save-db-btn { background: #2f855a; color: white; }
        .reset-db-btn { background: var(--danger); color: white; }
        .save-img-btn { background: #718096; color: white; width: 100%; margin-top: 20px; }
    </style>
</head>
<body>

<div class="container">
    <h1 onclick="handleAdminLogin()">편백나무 주차 구역 배정</h1>
    <div id="adminBadge" class="admin-badge">관리자 모드 활성화</div>

    <div id="unitWrapper" class="dong-wrapper">
        <div class="dong-column"><div class="dong-title">A동 세대</div><div id="list-A"></div></div>
        <div class="dong-column"><div class="dong-title">B동 세대</div><div id="list-B"></div></div>
        <div class="dong-column"><div class="dong-title">C동 세대</div><div id="list-C"></div></div>
    </div>

    <div id="printArea">
        <div id="summaryArea" class="summary-box"></div>
        <div class="map-section">
            <div class="map-container" id="mainMap"></div>
        </div>
    </div>

    <div id="adminControls">
        <p style="font-weight: bold; color: var(--danger); margin-bottom: 10px;">??? 관리자 제어판</p>
        <div style="display: flex; justify-content: center; flex-wrap: wrap;">
            <button class="btn draw-btn" onclick="executeDraw()">?? 추첨 시작</button>
            <button class="btn save-db-btn" onclick="saveToFirebase()">?? 서버에 결과 저장</button>
            <button class="btn reset-db-btn" onclick="resetDatabase()">?? 서버 데이터 초기화</button>
        </div>
        <button class="btn save-img-btn" onclick="saveAsImage()">?? 현재 결과 이미지로 저장</button>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyC0jloY1-k3bzz4HuPrmpL0wdtzHYMw-FE",
        databaseURL: "https://parking-bd6fa-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "parking-bd6fa"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    
    let isAdmin = false;
    let clickCount = 0;

    function init() {
        createUnitList();
        renderMap();
        loadFromFirebase();
    }

    function createUnitList() {
        const skip = ['A동 201호', 'A동 202호', 'A동 401호', 'C동 202호', 'C동 502호'];
        const fixed = ['B동 302호', 'C동 403호'];
        ['A','B','C'].forEach(dong => {
            const container = document.getElementById('list-' + dong);
            container.innerHTML = "";
            for(let f=2; f<=5; f++){
                let rooms = (dong === 'B' && f > 3) || (dong === 'C' && f === 5) ? 2 : 3;
                for(let r=1; r<=rooms; r++){
                    let name = `${dong}동 ${f}0${r}호`;
                    let isChecked = !skip.includes(name) && !fixed.includes(name);
                    container.innerHTML += `<div class="list-item"><label><input type="checkbox" class="chk-draw" ${isChecked?'checked':''} value="${name}" data-dong="${dong}" disabled> ${f}0${r}호</label></div>`;
                }
            }
        });
    }

    function renderMap() {
        const map = document.getElementById('mainMap');
        const makeRow = (layout, tag) => `<div class="parking-row">` + layout.map(t => {
            if(t === 'P') return `<div class="slot type-pillar">기둥</div>`;
            if(t === 'E') return `<div class="slot type-entrance">??<br>출입문</div>`;
            if(t === 'D') return `<div class="slot type-disabled">?<br>장애인</div>`;
            return `<div class="slot" data-role="parking" data-tag="${tag}"><input type="checkbox" class="slot-toggle" checked onchange="updateStyle(this)"><strong class="slot-text">${tag}</strong></div>`;
        }).join('') + `</div>`;

        map.innerHTML = `
            <div class="building-box"><div class="label">A동 필로티</div>${makeRow(['S','S','P','S','E','S','P','S'], 'A')}${makeRow(['S','S','P','S','P','D'], 'A')}</div>
            <div class="joint-box"><div class="label joint-label">A-B 공동</div>${makeRow(['D', 'S'], 'AB')}${makeRow(['S', 'S'], 'AB')}</div>
            <div class="building-box"><div class="label">B동 필로티</div>${makeRow(['S','S','E','S','S'], 'B')}${makeRow(['S','S','P','S','P','S','S'], 'B')}</div>
            <div class="joint-box"><div class="label joint-label">B-C 공동</div>${makeRow(['S', 'S'], 'BC')}${makeRow(['S', 'S'], 'BC')}</div>
            <div class="building-box"><div class="label">C동 필로티</div>${makeRow(['S','S','E','S','S'], 'C')}${makeRow(['D','P','S','S'], 'C')}</div>`;
    }

    function handleAdminLogin() {
        if (++clickCount >= 5) {
            if (prompt("비밀번호") === "1234") {
                isAdmin = true;
                document.getElementById('adminControls').style.display = 'block';
                document.getElementById('adminBadge').style.display = 'inline-block';
                document.getElementById('unitWrapper').style.display = 'flex';
                document.querySelectorAll('.chk-draw').forEach(el => el.disabled = false);
                document.querySelectorAll('.slot-toggle').forEach(el => el.style.display = 'block');
            }
            clickCount = 0;
        }
    }

    function executeDraw() {
        let apps = Array.from(document.querySelectorAll('.chk-draw:checked')).map(e => ({ name: e.value, dong: e.dataset.dong }));
        let slots = Array.from(document.querySelectorAll('.slot[data-role="parking"]')).filter(s => !s.classList.contains('is-unassigned'));
        if (!apps.length) return alert("신청 세대가 없습니다.");

        let shuffled = apps.sort(() => Math.random() - 0.5);
        let win = shuffled.slice(0, slots.length);
        let lose = shuffled.slice(slots.length);

        slots.forEach(s => { s.querySelector('.slot-text').innerText = ""; s.classList.remove('filled'); });

        win.forEach((p, i) => {
            if (slots[i]) {
                slots[i].querySelector('.slot-text').innerText = p.name.replace('동 ', '동\n');
                slots[i].classList.add('filled');
            }
        });

        const sArea = document.getElementById('summaryArea');
        sArea.style.display = 'block';
        sArea.innerHTML = `<h3>?? 추첨 완료 리포트</h3><p>? 가용 구역: ${slots.length} | 신청: ${apps.length}</p><p>? 당첨: ${win.length} 세대</p>` + 
            (lose.length ? `<div style="color:red; font-weight:bold; margin-top:10px;">대기자 순번: ${lose.map(l => l.name).join(', ')}</div>` : "");
    }

    function saveToFirebase() {
        if (!confirm("이 상태(비지정 포함)를 서버에 저장하시겠습니까?")) return;
        const slotsData = Array.from(document.querySelectorAll('.slot[data-role="parking"]')).map(s => ({
            text: s.querySelector('.slot-text').innerText,
            filled: s.classList.contains('filled'),
            un: s.classList.contains('is-unassigned'),
            tag: s.dataset.tag
        }));
        db.ref('parking_result').set({ slots: slotsData, report: document.getElementById('summaryArea').innerHTML })
            .then(() => alert("서버 저장 완료!"));
    }

    function resetDatabase() {
        if (!confirm("정말로 모든 데이터를 초기화하시겠습니까?")) return;
        db.ref('parking_result').remove().then(() => {
            alert("초기화되었습니다.");
            location.reload();
        });
    }

    function loadFromFirebase() {
        db.ref('parking_result').on('value', s => {
            const d = s.val();
            const slots = document.querySelectorAll('.slot[data-role="parking"]');
            
            if (d && d.slots) {
                d.slots.forEach((item, i) => {
                    if (slots[i]) {
                        slots[i].querySelector('.slot-text').innerText = item.text;
                        if (item.filled) slots[i].classList.add('filled'); else slots[i].classList.remove('filled');
                        if (item.un) slots[i].classList.add('is-unassigned'); else slots[i].classList.remove('is-unassigned');
                    }
                });
                if (d.report) {
                    document.getElementById('summaryArea').innerHTML = d.report;
                    document.getElementById('summaryArea').style.display = 'block';
                }
                if (!isAdmin) document.getElementById('unitWrapper').style.display = 'none';
            } else {
                slots.forEach(s => {
                    s.querySelector('.slot-text').innerText = s.dataset.tag;
                    s.classList.remove('filled', 'is-unassigned');
                });
                document.getElementById('summaryArea').style.display = 'none';
                if (!isAdmin) document.getElementById('unitWrapper').style.display = 'flex';
            }
        });
    }

    function updateStyle(c) {
        const s = c.closest('.slot');
        if (c.checked) {
            s.classList.remove('is-unassigned');
            s.querySelector('.slot-text').innerText = s.dataset.tag;
        } else {
            s.classList.add('is-unassigned');
            s.querySelector('.slot-text').innerText = "비지정";
        }
    }

    function saveAsImage() {
        html2canvas(document.getElementById('printArea'), { scale: 2 }).then(canvas => {
            const a = document.createElement('a');
            a.download = 'parking_map.png';
            a.href = canvas.toDataURL();
            a.click();
        });
    }

    init();
</script>
</body>
</html>
