<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>í¸ë°±ë‚˜ë¬´ ì£¼ì°¨ ë°°ì • ì‹œìŠ¤í…œ</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root { --primary: #34495e; --accent: #3182ce; --danger: #e53e3e; --joint-bg: #f8fafc; }
        body { font-family: 'Apple SD Gothic Neo', sans-serif; background-color: #f4f7f9; margin: 0; padding: 15px; color: #333; }
        
        .container { max-width: 800px; margin: auto; background: white; padding: 20px; border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.05); }
        h1 { margin: 0 0 20px 0; font-size: 1.4rem; text-align: center; color: var(--primary); }
        
        /* ì„¸ëŒ€ ëª…ë‹¨ (ê´€ë¦¬ììš© - í‰ì†Œ ìˆ¨ê¹€) */
        .dong-wrapper { display: none; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .dong-column { flex: 1; min-width: 120px; background: #fff; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 12px; }
        .list-item { border-bottom: 1px solid #eee; padding: 2px 0; }
        
        /* â˜…â˜…â˜… í•µì‹¬ ë ˆì´ì•„ì›ƒ: êµ¬ì—­ë³„ ì„¸ë¡œ ë°°ì¹˜ â˜…â˜…â˜… */
        .map-section { display: flex; flex-direction: column; gap: 30px; align-items: center; margin-top: 20px; }

        /* ê°œë³„ êµ¬ì—­ ë°•ìŠ¤ ìŠ¤íƒ€ì¼ */
        .zone-container {
            width: 100%;
            max-width: 600px; /* PCì—ì„  ë„ˆë¬´ ë„“ì§€ ì•Šê²Œ */
            position: relative;
            padding: 30px 10px 15px 10px;
            border-radius: 12px;
            box-sizing: border-box;
            background: #fff;
            /* ëª¨ë°”ì¼ì—ì„œ ë°•ìŠ¤ ë‚´ë¶€ ë‚´ìš©ì´ ë„˜ì¹˜ë©´ ê·¸ ë°•ìŠ¤ë§Œ ìŠ¤í¬ë¡¤ */
            overflow-x: auto; 
            -webkit-overflow-scrolling: touch;
        }

        /* ê±´ë¬¼(í•„ë¡œí‹°) ìŠ¤íƒ€ì¼: ì‹¤ì„  í…Œë‘ë¦¬ */
        .style-building { border: 2px solid var(--primary); }
        /* ê³µë™êµ¬ì—­ ìŠ¤íƒ€ì¼: ì ì„  í…Œë‘ë¦¬ + ì—°í•œ ë°°ê²½ */
        .style-joint { border: 2px dashed var(--accent); background-color: var(--joint-bg); }

        /* êµ¬ì—­ ë¼ë²¨ (ì¢Œì¸¡ ìƒë‹¨ ê³ ì •) */
        .zone-label {
            position: absolute;
            top: -12px;
            left: 20px;
            background: var(--primary);
            color: white;
            padding: 4px 12px;
            border-radius: 4px;
            font-size: 13px;
            font-weight: bold;
            white-space: nowrap;
            z-index: 5;
        }
        .style-joint .zone-label { background: var(--accent); }

        /* ì£¼ì°¨ì¹¸ë“¤ì„ ê°ì‹¸ëŠ” ë‚´ë¶€ ë˜í¼ (ê°€ë¡œ ì •ë ¬ ìœ ì§€ìš©) */
        .slots-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            /* ë‚´ìš©ë¬¼ì´ ì°Œê·¸ëŸ¬ì§€ì§€ ì•Šë„ë¡ ìµœì†Œ ë„ˆë¹„ ë³´ì¥ */
            min-width: max-content; 
            margin: 0 auto;
        }

        /* ì£¼ì°¨ í•œ ì¤„ (Row) */
        .parking-row { display: flex; gap: 6px; margin-bottom: 6px; justify-content: center; }

        /* ì£¼ì°¨ì¹¸ ë””ìì¸ (ì¹´ë“œ í˜•íƒœ) */
        .slot {
            width: 65px; height: 85px;
            border: 1px solid #cbd5e0; border-radius: 5px;
            background: #fff;
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            font-size: 12px; text-align: center;
            position: relative;
            box-shadow: 1px 1px 3px rgba(0,0,0,0.1);
        }

        /* ìŠ¬ë¡¯ ìƒíƒœ */
        .slot.filled { background-color: #ebf8ff; border: 2px solid var(--accent); color: var(--accent); font-weight: bold; }
        .slot.is-unassigned { border: 2px dashed #cbd5e0; background: #f8fafc; color: #aaa; }
        
        /* íŠ¹ìˆ˜ ìŠ¬ë¡¯ */
        .type-pillar { background: #95a5a6; border: none; width: 30px; box-shadow: none; color: transparent; } 
        .type-pillar::after { content:''; width:8px; height:8px; background:#bdc3c7; border-radius:50%; }
        .type-entrance { background: #3182ce; color: white; border: none; font-weight: bold; width: 70px; }
        .type-disabled { background: #2c5282; color: white; border: none; font-weight: bold; }

        /* ê´€ë¦¬ììš© ì²´í¬ë°•ìŠ¤ */
        .slot-toggle { position: absolute; top: 2px; left: 2px; transform: scale(0.8); z-index: 10; display: none; }

        /* ê´€ë¦¬ì íŒ¨ë„ */
        #adminControls { display: none; margin-top: 30px; padding: 15px; background: #fff5f5; border: 1px solid var(--danger); border-radius: 10px; }
        .btn { padding: 10px 15px; border: none; border-radius: 5px; color: white; font-weight: bold; cursor: pointer; margin: 5px; font-size: 14px; }
        .btn-draw { background: var(--primary); }
        .btn-save { background: #2f855a; }
        .btn-reset { background: var(--danger); }
        .btn-img { background: #718096; display: block; width: 100%; margin-top: 10px; }
        #summaryArea { display:none; background:#edf2f7; padding:15px; margin-bottom:20px; border-radius:8px; text-align:left; font-size:13px; line-height:1.6; }
    </style>
</head>
<body>

<div class="container">
    <h1 onclick="handleAdminLogin()">ğŸš™ í¸ë°±ë‚˜ë¬´ ì£¼ì°¨ ë°°ì •</h1>
    
    <div id="unitWrapper" class="dong-wrapper">
        <div class="dong-column"><strong>Aë™</strong><div id="list-A"></div></div>
        <div class="dong-column"><strong>Bë™</strong><div id="list-B"></div></div>
        <div class="dong-column"><strong>Cë™</strong><div id="list-C"></div></div>
    </div>

    <div id="printArea">
        <div id="summaryArea"></div>

        <div class="map-section">
            
            <div class="zone-container style-building">
                <div class="zone-label">Aë™ í•„ë¡œí‹°</div>
                <div class="slots-wrapper" id="zone-A">
                    </div>
            </div>

            <div class="zone-container style-joint">
                <div class="zone-label">A-B ì‚¬ì´ ê³µë™</div>
                <div class="slots-wrapper" id="zone-AB"></div>
            </div>

            <div class="zone-container style-building">
                <div class="zone-label">Bë™ í•„ë¡œí‹°</div>
                <div class="slots-wrapper" id="zone-B"></div>
            </div>

            <div class="zone-container style-joint">
                <div class="zone-label">B-C ì‚¬ì´ ê³µë™</div>
                <div class="slots-wrapper" id="zone-BC"></div>
            </div>

            <div class="zone-container style-building">
                <div class="zone-label">Cë™ í•„ë¡œí‹°</div>
                <div class="slots-wrapper" id="zone-C"></div>
            </div>

        </div>
    </div>

    <div id="adminControls">
        <h3 style="margin:0 0 10px 0;">âš™ï¸ ê´€ë¦¬ì ê¸°ëŠ¥</h3>
        <div style="display:flex; justify-content:center; flex-wrap:wrap;">
            <button class="btn btn-draw" onclick="executeDraw()">ğŸ² ì¶”ì²¨ ì‹¤í–‰</button>
            <button class="btn btn-save" onclick="saveData()">ğŸ’¾ ì €ì¥</button>
            <button class="btn btn-reset" onclick="resetData()">ğŸ§¹ ì´ˆê¸°í™”</button>
        </div>
        <button class="btn btn-img" onclick="saveImage()">ğŸ“¸ ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ</button>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyC0jloY1-k3bzz4HuPrmpL0wdtzHYMw-FE",
        databaseURL: "https://parking-bd6fa-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "parking-bd6fa"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const skipList = ['Aë™ 201í˜¸', 'Aë™ 202í˜¸', 'Aë™ 401í˜¸', 'Cë™ 202í˜¸', 'Cë™ 502í˜¸'];
    const fixedList = { 'Cë™ 403í˜¸': 'Cë™ ì¥ì• ì¸' }; 
    let isAdmin = false;
    let clickCount = 0;

    function init() {
        createUnitList();
        renderAllZones();
        loadData();
    }

    // ì„¸ëŒ€ ë¦¬ìŠ¤íŠ¸ ìƒì„±
    function createUnitList() {
        ['A','B','C'].forEach(dong => {
            const container = document.getElementById(`list-${dong}`);
            container.innerHTML = "";
            for(let f=2; f<=5; f++){
                let rooms = (dong === 'B' && f > 3) || (dong === 'C' && f === 5) ? 2 : 3;
                for(let r=1; r<=rooms; r++){
                    const name = `${dong}ë™ ${f}0${r}í˜¸`;
                    let isSkipped = skipList.includes(name);
                    let isFixed = fixedList[name];
                    let label = name;
                    let disabled = 'disabled';
                    let checked = (!isSkipped && !isFixed) ? 'checked' : '';
                    
                    if(isSkipped) label += " <span style='color:#ccc'>(x)</span>";
                    if(isFixed) label += " <span style='color:blue'>(ê³ ì •)</span>";

                    container.innerHTML += `<div class="list-item"><label><input type="checkbox" class="chk-unit" value="${name}" data-dong="${dong}" ${checked} ${disabled}> ${label}</label></div>`;
                }
            }
        });
    }

    // â˜… ë§µ ë Œë”ë§ í•¨ìˆ˜ (ê° êµ¬ì—­ë³„ë¡œ ê·¸ë¦¬ê¸°) â˜…
    function renderAllZones() {
        // ê³µí†µ í–‰ ìƒì„± í—¬í¼
        const makeRow = (arr, zone) => {
            return `<div class="parking-row">` + arr.map(type => {
                if(type === 'P') return `<div class="slot type-pillar"></div>`;
                if(type === 'E') return `<div class="slot type-entrance">ì¶œì…êµ¬</div>`;
                if(type === 'D') {
                    const txt = zone === 'C' ? 'Cì¥ì• ì¸\n(403í˜¸)' : 'ì¥ì• ì¸';
                    return `<div class="slot type-disabled">${txt}</div>`;
                }
                // ì¼ë°˜ ì£¼ì°¨ì¹¸
                return `<div class="slot" data-role="parking" data-zone="${zone}">
                            <input type="checkbox" class="slot-toggle" checked onchange="toggleSlot(this)">
                            <span class="slot-txt">${zone}</span>
                        </div>`;
            }).join('') + `</div>`;
        };

        // 1. Aë™ (ìœ„: SSP S E SPS / ì•„ë˜: SSP S P D)
        document.getElementById('zone-A').innerHTML = 
            makeRow(['S','S','P','S','E','S','P','S'], 'A') + 
            makeRow(['S','S','P','S','P','D'], 'A');

        // 2. AB ê³µë™ (ìœ„: D S / ì•„ë˜: S S)
        document.getElementById('zone-AB').innerHTML = 
            makeRow(['D','S'], 'AB') + 
            makeRow(['S','S'], 'AB');

        // 3. Bë™ (ìœ„: SS E SS / ì•„ë˜: SS P S P SS)
        document.getElementById('zone-B').innerHTML = 
            makeRow(['S','S','E','S','S'], 'B') + 
            makeRow(['S','S','P','S','P','S','S'], 'B');

        // 4. BC ê³µë™ (ìœ„: S S / ì•„ë˜: S S)
        document.getElementById('zone-BC').innerHTML = 
            makeRow(['S','S'], 'BC') + 
            makeRow(['S','S'], 'BC');

        // 5. Cë™ (ìœ„: SS E SS / ì•„ë˜: D P SS)
        document.getElementById('zone-C').innerHTML = 
            makeRow(['S','S','E','S','S'], 'C') + 
            makeRow(['D','P','S','S'], 'C');
    }

    // ==========================================
    // ë¡œì§: ê·œì¹™ ì ìš© ì¶”ì²¨ (ì´ì „ê³¼ ë™ì¼)
    // ==========================================
    function executeDraw() {
        if(!confirm("ê¸°ì¡´ ë°°ì •ì„ ì´ˆê¸°í™”í•˜ê³  ìƒˆë¡œ ì¶”ì²¨í•©ë‹ˆë‹¤.")) return;
        
        // 1. ì‹ ì²­ì ë° ìŠ¬ë¡¯ í™•ë³´
        const applicants = Array.from(document.querySelectorAll('.chk-unit:checked')).map(el => ({name: el.value, dong: el.dataset.dong}));
        const getSlots = (z) => Array.from(document.querySelectorAll(`.slot[data-zone="${z}"]:not(.is-unassigned)`));
        
        if(!applicants.length) return alert("ëŒ€ìƒìê°€ ì—†ìŠµë‹ˆë‹¤.");

        // ì´ˆê¸°í™”
        document.querySelectorAll('.slot[data-role="parking"]').forEach(s => {
            s.classList.remove('filled');
            s.querySelector('.slot-txt').innerText = s.dataset.zone;
        });

        // 2. ê·¸ë£¹í•‘ ë° ì…”í”Œ
        const shuffle = arr => arr.sort(() => Math.random() - 0.5);
        let gA = shuffle(applicants.filter(p => p.dong === 'A'));
        let gB = shuffle(applicants.filter(p => p.dong === 'B'));
        let gC = shuffle(applicants.filter(p => p.dong === 'C'));

        // 3. ë‹¨ê³„ë³„ ë°°ì • í•¨ìˆ˜
        function assign(people, slots) {
            let win = [], lose = [];
            if(people.length <= slots.length) {
                win = people;
                // ë‚¨ì€ ìŠ¬ë¡¯ì€ ë¹ˆì¹¸ìœ¼ë¡œ ë‘ 
            } else {
                win = people.slice(0, slots.length);
                lose = people.slice(slots.length);
            }
            
            // UI ë°˜ì˜
            win.forEach((p, i) => {
                slots[i].classList.add('filled');
                slots[i].querySelector('.slot-txt').innerText = p.name.replace('ë™ ', '\n');
            });
            return { win, lose };
        }

        // Step 1: ê° ë™ í•„ë¡œí‹°
        let resA = assign(gA, getSlots('A'));
        let resB = assign(gB, getSlots('B'));
        let resC = assign(gC, getSlots('C'));

        // Step 2: AB ê³µë™êµ¬ì—­ (Aíƒˆë½ + Bíƒˆë½)
        let poolAB = shuffle([...resA.lose, ...resB.lose]);
        let resAB = assign(poolAB, getSlots('AB'));

        // Step 3: BC ê³µë™êµ¬ì—­ (ABì—ì„œ ë–¨ì–´ì§„ B + Cíƒˆë½)
        // * ABì—ì„œ ë–¨ì–´ì§„ AëŠ” ê°ˆê³³ì´ ì—†ìŒ(ì™„ì „íƒˆë½)
        let failedFromAB_B = resAB.lose.filter(p => p.dong === 'B');
        let failedFromAB_A = resAB.lose.filter(p => p.dong === 'A');

        let poolBC = shuffle([...failedFromAB_B, ...resC.lose]);
        let resBC = assign(poolBC, getSlots('BC'));

        // ê²°ê³¼ ë¦¬í¬íŠ¸
        const finalLose = [...failedFromAB_A, ...resBC.lose];
        const totalWin = applicants.length - finalLose.length;

        const summary = document.getElementById('summaryArea');
        summary.innerHTML = `
            <strong>ğŸ“Š ê²°ê³¼ ë¦¬í¬íŠ¸</strong><br>
            â€¢ ì´ ì‹ ì²­: ${applicants.length} / ë°°ì •: ${totalWin}<br>
            â€¢ Aë™ í•„ë¡œí‹°: ${resA.win.length}ì„¸ëŒ€<br>
            â€¢ Bë™ í•„ë¡œí‹°: ${resB.win.length}ì„¸ëŒ€<br>
            â€¢ Cë™ í•„ë¡œí‹°: ${resC.win.length}ì„¸ëŒ€<br>
            â€¢ ê³µë™êµ¬ì—­(AB/BC): ${resAB.win.length + resBC.win.length}ì„¸ëŒ€<br>
            ${finalLose.length ? `<span style="color:red">âš ï¸ ëŒ€ê¸°ì(${finalLose.length}): ${finalLose.map(p=>p.name).join(', ')}</span>` : '<span style="color:green">ğŸ‰ ì „ì› ë°°ì • ì™„ë£Œ!</span>'}
        `;
        summary.style.display = 'block';
    }

    // ì„œë²„ ì €ì¥/ë¡œë“œ/ì´ˆê¸°í™” (Firebase)
    function saveData() {
        if(!confirm("ì„œë²„ì— ì €ì¥í•©ë‹ˆê¹Œ?")) return;
        const data = [];
        document.querySelectorAll('.slot[data-role="parking"]').forEach(s => {
            data.push({
                zone: s.dataset.zone,
                txt: s.querySelector('.slot-txt').innerText,
                filled: s.classList.contains('filled'),
                unassigned: s.classList.contains('is-unassigned')
            });
        });
        db.ref('parking_v3').set({
            map: data, 
            report: document.getElementById('summaryArea').innerHTML
        }).then(() => alert("ì €ì¥ ì™„ë£Œ"));
    }

    function loadData() {
        db.ref('parking_v3').on('value', snap => {
            const d = snap.val();
            if(!d) return;
            
            // ë§µ ë°ì´í„° ë³µì› (ìˆœì„œëŒ€ë¡œ ë§¤ì¹­ - data-role="parking" ìš”ì†Œë“¤)
            const slots = document.querySelectorAll('.slot[data-role="parking"]');
            if(d.map) {
                d.map.forEach((item, i) => {
                    if(slots[i]) {
                        slots[i].querySelector('.slot-txt').innerText = item.txt;
                        if(item.filled) slots[i].classList.add('filled');
                        else slots[i].classList.remove('filled');
                        
                        if(item.unassigned) slots[i].classList.add('is-unassigned');
                        else slots[i].classList.remove('is-unassigned');
                    }
                });
            }
            if(d.report) {
                document.getElementById('summaryArea').innerHTML = d.report;
                document.getElementById('summaryArea').style.display = 'block';
            }
        });
    }

    function resetData() {
        if(confirm("ì •ë§ ì´ˆê¸°í™” í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
            db.ref('parking_v3').remove();
            location.reload();
        }
    }

    function toggleSlot(chk) {
        const s = chk.closest('.slot');
        if(chk.checked) {
            s.classList.remove('is-unassigned');
            s.querySelector('.slot-txt').innerText = s.dataset.zone;
        } else {
            s.classList.add('is-unassigned');
            s.querySelector('.slot-txt').innerText = "ë¹„ì§€ì •";
        }
    }

    function handleAdminLogin() {
        clickCount++;
        if(clickCount >= 5) {
            if(prompt("ê´€ë¦¬ì ì•”í˜¸") === "1234") {
                isAdmin = true;
                document.getElementById('adminControls').style.display = 'block';
                document.getElementById('unitWrapper').style.display = 'flex';
                document.querySelectorAll('.chk-unit').forEach(e => e.disabled = false);
                document.querySelectorAll('.slot-toggle').forEach(e => e.style.display = 'block');
            }
            clickCount = 0;
        }
    }

    function saveImage() {
        window.scrollTo(0,0);
        html2canvas(document.getElementById('printArea'), {scale: 2}).then(canvas => {
            const a = document.createElement('a');
            a.download = 'ì£¼ì°¨ë°°ì •ê²°ê³¼.png';
            a.href = canvas.toDataURL();
            a.click();
        });
    }

    init();
</script>
</body>
</html>
