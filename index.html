<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>í¸ë°±ë‚˜ë¬´ ì£¼ì°¨ ê´€ë¦¬ ì‹œìŠ¤í…œ</title>

  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <style>
    :root { --primary: #34495e; --accent: #3182ce; --danger: #e53e3e; --joint: #f8fafc; --warn: #f59e0b; }
    body { font-family: 'Apple SD Gothic Neo', sans-serif; text-align: center; background-color: #f4f7f9; margin: 0; padding: 20px; color: #333; }
    .container { max-width: 1100px; margin: auto; background: white; padding: 30px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
    h1 { cursor: pointer; user-select: none; margin-bottom: 5px; padding: 10px; }

    /* ê´€ë¦¬ì ëª¨ë“œ ë°°ì§€ */
    .admin-badge { display: none; color: #3182ce; font-size: 14px; font-weight: bold; border: 1px solid #3182ce; padding: 2px 10px; border-radius: 20px; margin: 10px 0; }

    /* ê²°ê³¼ ë¦¬í¬íŠ¸ ë°•ìŠ¤ */
    .summary-box { display: none; background: #fff; border: 3px solid var(--accent); padding: 25px; border-radius: 15px; margin: 20px 0 40px 0; text-align: left; line-height: 1.6; }

    /* ë™ë³„ ë¦¬ìŠ¤íŠ¸ */
    .dong-wrapper { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 30px; }
    .dong-column { flex: 1; min-width: 300px; background: #fff; padding: 15px; border-radius: 12px; border: 1px solid #e2e8f0; }
    .dong-title { font-weight: bold; margin-bottom: 10px; padding: 8px; background: #f8fafc; border-radius: 6px; border-bottom: 2px solid var(--primary); }
    .list-item { display: flex; align-items: center; justify-content: space-between; margin-bottom: 5px; font-size: 13px; padding: 4px 10px; border-radius: 4px; border: 1px solid #f1f5f9; }

    /* ì§€ë„ ì˜ì—­ */
    .map-section { margin: 20px 0; padding: 20px; background: #fdfdfd; border: 1px solid #cbd5e0; border-radius: 15px; }
    .map-container { display: flex; flex-direction: column; gap: 15px; align-items: center; }
    .building-box { width: 100%; border: 2px solid var(--primary); border-radius: 10px; padding: 45px 15px 20px; position: relative; background: white; box-sizing: border-box; margin-bottom: 20px; }
    .joint-box { width: 100%; border: 1px dashed var(--accent); border-radius: 10px; padding: 25px 15px 15px; position: relative; background: var(--joint); box-sizing: border-box; margin-bottom: 20px; }
    .label { position: absolute; top: -13px; left: 20px; padding: 3px 15px; font-size: 12px; border-radius: 4px; font-weight: bold; background: var(--primary); color: white; }
    .joint-label { background: var(--accent); }

    /* ì£¼ì°¨ ìŠ¬ë¡¯ ìŠ¤íƒ€ì¼ */
    .parking-row { display: flex; justify-content: center; gap: 8px; margin: 8px 0; flex-wrap: wrap; }
    .slot { width: 85px; height: 110px; border: 1px solid #dcdde1; border-radius: 6px; position: relative; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 12px; background: #fff; white-space: pre-line; line-height: 1.3; }
    .slot-toggle { position: absolute; top: 6px; left: 6px; transform: scale(1.3); cursor: pointer; z-index: 20; display: none; }

    .slot.filled { background-color: #ebf8ff !important; border: 2px solid var(--accent) !important; color: var(--primary) !important; font-weight: bold; }
    .slot.is-unassigned { background-color: #f1f5f9 !important; border: 2px dashed #cbd5e0 !important; color: #94a3b8 !important; }

    /* ìˆ˜ê¸°(ì˜¤ë²„ë¼ì´ë“œ) í‘œì‹œ */
    .slot.manual-locked { outline: 3px solid var(--warn); outline-offset: 2px; }

    /* íŠ¹ìˆ˜ êµ¬ì—­ ìŠ¤íƒ€ì¼ */
    .type-pillar { width: 40px; background: #95a5a6; color: white; border: none; }
    .type-entrance { width: 100px; background: #3182ce; color: white; border: none; font-weight: bold; font-size: 11px; }
    .type-disabled { background-color: #2b6cb0; color: white; border: none; font-weight: bold; cursor: pointer; }

    /* ê´€ë¦¬ì íŒ¨ë„ */
    #adminControls { display: none; margin: 20px 0; padding: 20px; background: #fef2f2; border-radius: 10px; border: 2px solid var(--danger); }
    .btn { padding: 12px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 15px; margin: 5px; transition: 0.2s; }
    .draw-btn { background: var(--primary); color: white; }
    .save-db-btn { background: #2f855a; color: white; }
    .reset-db-btn { background: var(--danger); color: white; }
    .save-img-btn { background: #718096; color: white; width: 100%; margin-top: 20px; }

    /* ì•ˆë‚´ ë¬¸êµ¬ */
    .hint { font-size: 12px; color: #64748b; margin-top: 8px; }
  </style>
</head>

<body>
<div class="container">
  <h1 onclick="handleAdminLogin()">í¸ë°±ë‚˜ë¬´ ì£¼ì°¨ êµ¬ì—­ ë°°ì •</h1>
  <div id="adminBadge" class="admin-badge">ê´€ë¦¬ì ëª¨ë“œ í™œì„±í™”</div>

  <div id="unitWrapper" class="dong-wrapper">
    <div class="dong-column"><div class="dong-title">Aë™ ì„¸ëŒ€</div><div id="list-A"></div></div>
    <div class="dong-column"><div class="dong-title">Bë™ ì„¸ëŒ€</div><div id="list-B"></div></div>
    <div class="dong-column"><div class="dong-title">Cë™ ì„¸ëŒ€</div><div id="list-C"></div></div>
  </div>

  <div id="printArea">
    <div id="summaryArea" class="summary-box"></div>
    <div class="map-section">
      <div class="map-container" id="mainMap"></div>
      <div class="hint">â€» ê´€ë¦¬ì ëª¨ë“œì—ì„œ ìŠ¬ë¡¯ì„ í´ë¦­í•˜ë©´ ìˆ˜ê¸° í‘œê¸°ë¥¼ ì…ë ¥/í•´ì œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤(ë¹ˆì¹¸ ì…ë ¥ ì‹œ í•´ì œ).</div>
    </div>
  </div>

  <div id="adminControls">
    <p style="font-weight: bold; color: var(--danger); margin-bottom: 10px;">ğŸ› ï¸ ê´€ë¦¬ì ì œì–´íŒ</p>
    <div style="display: flex; justify-content: center; flex-wrap: wrap;">
      <button class="btn draw-btn" onclick="executeDraw()">ğŸ² ê·œì¹™ëŒ€ë¡œ ì¶”ì²¨</button>
      <button class="btn save-db-btn" onclick="saveToFirebase()">ğŸ’¾ ì„œë²„ì— ê²°ê³¼ ì €ì¥</button>
      <button class="btn reset-db-btn" onclick="resetDatabase()">ğŸ§¹ ì„œë²„ ë°ì´í„° ì´ˆê¸°í™”</button>
      <button class="btn reset-db-btn" onclick="clearManualOverrides()">ğŸ§½ ìˆ˜ê¸°í‘œê¸° ì´ˆê¸°í™”</button>
    </div>
    <button class="btn save-img-btn" onclick="saveAsImage()">ğŸ“¸ í˜„ì¬ ê²°ê³¼ ì´ë¯¸ì§€ë¡œ ì €ì¥</button>
  </div>
</div>

<script>
  // --- Firebase ì„¤ì • ---
  const firebaseConfig = {
    apiKey: "AIzaSyC0jloY1-k3bzz4HuPrmpL0wdtzHYMw-FE",
    databaseURL: "https://parking-bd6fa-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "parking-bd6fa"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  let isAdmin = false;
  let clickCount = 0;

  // --- ì´ˆê¸°í™” ---
  function init() {
    createUnitList();
    renderMap();
    enableSlotManualEdit();
    loadFromFirebase();
  }

  // --- ì„¸ëŒ€ ë¦¬ìŠ¤íŠ¸ ìƒì„± ---
  function createUnitList() {
    const skip = ['Aë™ 201í˜¸', 'Aë™ 202í˜¸', 'Aë™ 401í˜¸', 'Cë™ 202í˜¸', 'Cë™ 502í˜¸'];
    const fixed = ['Bë™ 302í˜¸', 'Cë™ 403í˜¸'];

    ['A','B','C'].forEach(dong => {
      const container = document.getElementById('list-' + dong);
      container.innerHTML = "";

      for (let f = 2; f <= 5; f++) {
        let rooms = (dong === 'B' && f > 3) || (dong === 'C' && f === 5) ? 2 : 3;

        for (let r = 1; r <= rooms; r++) {
          let name = `${dong}ë™ ${f}0${r}í˜¸`;
          let isChecked = !skip.includes(name) && !fixed.includes(name);

          container.innerHTML += `
            <div class="list-item">
              <label>
                <input type="checkbox" class="chk-draw" ${isChecked ? 'checked' : ''} value="${name}" data-dong="${dong}" disabled>
                ${f}0${r}í˜¸
              </label>
            </div>`;
        }
      }
    });
  }

  // --- ì§€ë„ ë Œë”ë§ ---
  function renderMap() {
    const map = document.getElementById('mainMap');

    const makeRow = (layout, tag) => `<div class="parking-row">` + layout.map(t => {
      if (t === 'P') return `<div class="slot type-pillar">ê¸°ë‘¥</div>`;
      if (t === 'E') return `<div class="slot type-entrance">ğŸšª<br>ì¶œì…ë¬¸</div>`;

      // ì¥ì• ì¸(íŠ¹ìˆ˜) ìŠ¬ë¡¯: ì €ì¥/ìˆ˜ê¸°í‘œê¸° ê°€ëŠ¥í•˜ì§€ë§Œ ì¶”ì²¨ ëŒ€ìƒ ì•„ë‹˜
      if (t === 'D') {
        return `
          <div class="slot type-disabled"
               data-role="special"
               data-save="1"
               data-tag="${tag}">
            <strong class="slot-text">â™¿\nì¥ì• ì¸</strong>
          </div>`;
      }

      // ì¼ë°˜ ì£¼ì°¨ ìŠ¬ë¡¯: ì¶”ì²¨ ëŒ€ìƒ + ë¹„ì§€ì • í† ê¸€ + ì €ì¥/ìˆ˜ê¸°í‘œê¸° ê°€ëŠ¥
      return `
        <div class="slot"
             data-role="parking"
             data-save="1"
             data-tag="${tag}">
          <input type="checkbox" class="slot-toggle" checked onchange="updateStyle(this)">
          <strong class="slot-text">${tag}</strong>
        </div>`;
    }).join('') + `</div>`;

    map.innerHTML = `
      <div class="building-box">
        <div class="label">Aë™ í•„ë¡œí‹°</div>
        ${makeRow(['S','S','P','S','E','S','P','S'], 'A')}
        ${makeRow(['S','S','P','S','P','D'], 'A')}
      </div>

      <div class="joint-box">
        <div class="label joint-label">A-B ê³µë™</div>
        ${makeRow(['D','S'], 'AB')}
        ${makeRow(['S','S'], 'AB')}
      </div>

      <div class="building-box">
        <div class="label">Bë™ í•„ë¡œí‹°</div>
        ${makeRow(['S','S','E','S','S'], 'B')}
        ${makeRow(['S','S','P','S','P','S','S'], 'B')}
      </div>

      <div class="joint-box">
        <div class="label joint-label">B-C ê³µë™</div>
        ${makeRow(['S','S'], 'BC')}
        ${makeRow(['S','S'], 'BC')}
      </div>

      <div class="building-box">
        <div class="label">Cë™ í•„ë¡œí‹°</div>
        ${makeRow(['S','S','E','S','S'], 'C')}
        ${makeRow(['D','S','P','S','S'], 'C')}
      </div>
    `;
  }

  // --- ê´€ë¦¬ì ë¡œê·¸ì¸ ---
  function handleAdminLogin() {
    if (++clickCount >= 5) {
      if (prompt("ë¹„ë°€ë²ˆí˜¸") === "1234") {
        isAdmin = true;
        document.getElementById('adminControls').style.display = 'block';
        document.getElementById('adminBadge').style.display = 'inline-block';
        document.getElementById('unitWrapper').style.display = 'flex';
        document.querySelectorAll('.chk-draw').forEach(el => el.disabled = false);
        document.querySelectorAll('.slot-toggle').forEach(el => el.style.display = 'block');
      }
      clickCount = 0;
    }
  }

  // --- ìŠ¬ë¡¯ ìˆ˜ê¸° ì…ë ¥(ëª¨ë“  ì €ì¥ ëŒ€ìƒ ìŠ¬ë¡¯) ---
  function enableSlotManualEdit() {
    document.querySelectorAll('.slot[data-save="1"]').forEach(slot => {
      slot.addEventListener('click', (e) => {
        if (!isAdmin) return;
        if (e.target && e.target.classList.contains('slot-toggle')) return;

        const textEl = slot.querySelector('.slot-text');
        if (!textEl) return;

        const current = (slot.dataset.manualText ?? textEl.innerText).replace(/\n/g, ' ');
        const input = prompt(
          "í‘œê¸°í•  ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.\nì˜ˆ) Cë™ 403í˜¸ / ìì²˜ì‚¬ìš©(OOë‹˜)\n\në¹ˆì¹¸ìœ¼ë¡œ ë‘ë©´ 'ìˆ˜ê¸°í‘œê¸° í•´ì œ'",
          current
        );

        if (input === null) return; // ì·¨ì†Œ
        const trimmed = input.trim();

        if (trimmed === "") {
          // ìˆ˜ê¸°í‘œê¸° í•´ì œ
          delete slot.dataset.manualText;
          slot.classList.remove('manual-locked');

          // í˜„ì¬ ìƒíƒœ ê¸°ë°˜ ê¸°ë³¸ í‘œì‹œ ë³µêµ¬
          if (slot.dataset.role === 'parking') {
            if (slot.classList.contains('is-unassigned')) {
              textEl.innerText = "ë¹„ì§€ì •";
            } else if (slot.classList.contains('filled')) {
              // filledì¸ ê²½ìš° í˜„ì¬ í‘œì‹œ ìœ ì§€(ì¶”ì²¨/ì €ì¥ í…ìŠ¤íŠ¸ê°€ ì´ë¯¸ ë“¤ì–´ìˆìŒ)
              // í•„ìš”í•˜ë©´ ì•„ë˜ í•œ ì¤„ë¡œ tagë¡œ ê°•ì œ ë³µêµ¬ ê°€ëŠ¥:
              // textEl.innerText = slot.dataset.tag;
            } else {
              textEl.innerText = slot.dataset.tag;
            }
          } else {
            textEl.innerText = "â™¿\nì¥ì• ì¸";
          }
          return;
        }

        // ìˆ˜ê¸°í‘œê¸° ì ìš©
        slot.dataset.manualText = trimmed;
        textEl.innerText = trimmed.replace('ë™ ', 'ë™\n');
        slot.classList.add('manual-locked');

        // ìˆ˜ê¸°í‘œê¸°ëœ ì¹¸ì€ "ì‚¬ìš©ì¤‘"ìœ¼ë¡œ ë³´ì´ê²Œ filled ì²˜ë¦¬(ì›ì¹˜ ì•Šìœ¼ë©´ ì´ ì¤„ ì‚­ì œ)
        slot.classList.add('filled');
      });
    });
  }

  // --- ìˆ˜ê¸°í‘œê¸° ì´ˆê¸°í™”(ì „ì²´) ---
  function clearManualOverrides() {
    if (!isAdmin) {
      alert("ê´€ë¦¬ì ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.");
      return;
    }
    if (!confirm("ëª¨ë“  ì¹¸ì˜ 'ìˆ˜ê¸°í‘œê¸°'ë§Œ ì´ˆê¸°í™”í• ê¹Œìš”?\n(ì¶”ì²¨ ê²°ê³¼/ë¹„ì§€ì • ì„¤ì •ì€ ìœ ì§€ë©ë‹ˆë‹¤)")) return;

    document.querySelectorAll('.slot[data-save="1"]').forEach(slot => {
      if (!slot.dataset.manualText) return;

      delete slot.dataset.manualText;
      slot.classList.remove('manual-locked');

      const textEl = slot.querySelector('.slot-text');
      if (!textEl) return;

      // í˜„ì¬ ìƒíƒœì— ë§ì¶° ê¸°ë³¸ í‘œì‹œë¡œ ë³µêµ¬
      if (slot.dataset.role === "parking") {
        if (slot.classList.contains('is-unassigned')) {
          textEl.innerText = "ë¹„ì§€ì •";
        } else if (slot.classList.contains('filled')) {
          // filled(ì¶”ì²¨/ê¸°ì¡´ ì €ì¥ ê²°ê³¼) í…ìŠ¤íŠ¸ëŠ” ìœ ì§€
        } else {
          textEl.innerText = slot.dataset.tag;
        }
      } else {
        textEl.innerText = "â™¿\nì¥ì• ì¸";
      }
    });

    alert("ìˆ˜ê¸°í‘œê¸°ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.\nì›í•˜ì‹œë©´ 'ì„œë²„ì— ê²°ê³¼ ì €ì¥'ì„ ëˆŒëŸ¬ ë°˜ì˜í•˜ì„¸ìš”.");
  }

  // --- ì¶”ì²¨ ë¡œì§ ---
  function executeDraw() {
    // 1) ì‹ ì²­ ì„¸ëŒ€ ë¶„ë¦¬ ë° ëœë¤ ì…”í”Œ
    const getApps = (dong) => Array.from(document.querySelectorAll(`.chk-draw[data-dong="${dong}"]:checked`))
      .map(e => e.value).sort(() => Math.random() - 0.5);

    let appsA = getApps('A');
    let appsB = getApps('B');
    let appsC = getApps('C');

    // 2) êµ¬ì—­ ìŠ¬ë¡¯ í™•ë³´ (ë¹„ì§€ì • ì œì™¸ + ì¶”ì²¨ ëŒ€ìƒ(ì£¼ì°¨)ë§Œ)
    const getSlots = (tag) => Array.from(document.querySelectorAll(`.slot[data-role="parking"][data-tag="${tag}"]`))
      .filter(s => !s.classList.contains('is-unassigned'));

    let slotsA  = getSlots('A');
    let slotsB  = getSlots('B');
    let slotsC  = getSlots('C');
    let slotsAB = getSlots('AB');
    let slotsBC = getSlots('BC');

    // 3) ì´ˆê¸°í™”: ìˆ˜ê¸°í‘œê¸°(ì ê¸ˆ) ì¹¸ì€ ìœ ì§€, ë‚˜ë¨¸ì§€ë§Œ ì´ˆê¸°í™”
    document.querySelectorAll('.slot[data-role="parking"]').forEach(s => {
      const locked = (s.dataset.manualText && s.dataset.manualText.trim() !== "");
      if (locked) {
        // ì ê¸ˆì¹¸ì€ ì¶”ì²¨ì´ ê±´ë“œë¦¬ì§€ ì•Šë„ë¡ filled ìœ ì§€(ì´ë¯¸ ìˆ˜ê¸° ì…ë ¥ ì‹œ filled ë¶™ì„)
        s.classList.add('filled');
        return;
      }
      s.querySelector('.slot-text').innerText = s.dataset.tag;
      s.classList.remove('filled');
    });

    // ê²°ê³¼ ì €ì¥ìš©
    let losers = [];

    // ì±„ìš°ê¸°: ì ê¸ˆì¹¸ì€ ê±´ë„ˆë›°ê³  ë°°ì •
    const fillDirect = (apps, slots) => {
      while (apps.length > 0 && slots.length > 0) {
        let s = slots.shift();

        // ì ê¸ˆì¹¸ì€ ê±´ë„ˆë›°ê¸°
        while (s && s.dataset.manualText && s.dataset.manualText.trim() !== "") {
          s = slots.shift();
        }
        if (!s) break;

        let p = apps.shift();
        s.querySelector('.slot-text').innerText = p.replace('ë™ ', 'ë™\n');
        s.classList.add('filled');
      }
    };

    // [ê·œì¹™ 1] ê° ë™ ì „ìš© í•„ë¡œí‹° ë¨¼ì € ì±„ìš°ê¸°
    fillDirect(appsA, slotsA);
    fillDirect(appsB, slotsB);
    fillDirect(appsC, slotsC);

    // [ê·œì¹™ 2] A-B ê³µë™êµ¬ì—­: Aë™ ë¨¼ì €, ë‚¨ìœ¼ë©´ Bë™
    fillDirect(appsA, slotsAB);
    fillDirect(appsB, slotsAB);

    // [ê·œì¹™ 3] B-C ê³µë™êµ¬ì—­: Cë™ ë¨¼ì €, ë‚¨ìœ¼ë©´ Bë™
    fillDirect(appsC, slotsBC);
    fillDirect(appsB, slotsBC);

    // ë‚¨ì€ ì„¸ëŒ€ëŠ” ëŒ€ê¸°ì
    losers = [...appsA, ...appsB, ...appsC];

    // 4) ë¦¬í¬íŠ¸ ì¶œë ¥
    const sArea = document.getElementById('summaryArea');
    sArea.style.display = 'block';
    sArea.innerHTML =
      `<h3>ğŸ“Š êµ¬ì—­ë³„ ì¶”ì²¨ ê²°ê³¼</h3>` +
      `<p>â€¢ ë‹¹ì²¨/í‘œê¸° ì„¸ëŒ€ ìˆ˜: ${document.querySelectorAll('.slot.filled').length} ì¹¸</p>` +
      (losers.length ? `<div style="color:red; font-weight:bold; margin-top:10px;">âš ï¸ ëŒ€ê¸° ìˆœë²ˆ: ${losers.join(', ')}</div>` : "");
  }

  // --- ë¹„ì§€ì • í† ê¸€ ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸ ---
  function updateStyle(c) {
    const s = c.closest('.slot');

    if (c.checked) {
      s.classList.remove('is-unassigned');
      // ìˆ˜ê¸°í‘œê¸° ìˆìœ¼ë©´ í…ìŠ¤íŠ¸ëŠ” ê±´ë“œë¦¬ì§€ ì•ŠìŒ
      if (!(s.dataset.manualText && s.dataset.manualText.trim() !== "")) {
        s.querySelector('.slot-text').innerText = s.dataset.tag;
      }
    } else {
      s.classList.add('is-unassigned');
      if (!(s.dataset.manualText && s.dataset.manualText.trim() !== "")) {
        s.querySelector('.slot-text').innerText = "ë¹„ì§€ì •";
      }
    }
  }

  // --- ì„œë²„ ì €ì¥ ---
  function saveToFirebase() {
    if (!isAdmin) {
      alert("ê´€ë¦¬ì ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.");
      return;
    }
    if (!confirm("ì´ ê²°ê³¼ë¥¼ ì„œë²„ì— ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

    const slotsData = Array.from(document.querySelectorAll('.slot[data-save="1"]')).map(s => ({
      text: s.querySelector('.slot-text') ? s.querySelector('.slot-text').innerText : "",
      filled: s.classList.contains('filled'),
      un: s.classList.contains('is-unassigned'),
      tag: s.dataset.tag,
      role: s.dataset.role || "",
      manualText: s.dataset.manualText || ""
    }));

    db.ref('parking_result').set({
      slots: slotsData,
      report: document.getElementById('summaryArea').innerHTML
    })
    .then(() => alert("ì„œë²„ ì €ì¥ ì™„ë£Œ!"))
    .catch((error) => alert("ì €ì¥ ì‹¤íŒ¨: " + error.message));
  }

  // --- ë°ì´í„° ì´ˆê¸°í™”(ì„œë²„) ---
  function resetDatabase() {
    if (!isAdmin) {
      alert("ê´€ë¦¬ì ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.");
      return;
    }
    if (!confirm("ì •ë§ë¡œ ëª¨ë“  ë°ì´í„°ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

    db.ref('parking_result').remove().then(() => {
      alert("ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.");
      location.reload();
    }).catch((error) => alert("ì´ˆê¸°í™” ì‹¤íŒ¨: " + error.message));
  }

  // --- ì„œë²„ì—ì„œ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ---
  function loadFromFirebase() {
    db.ref('parking_result').on('value', s => {
      const d = s.val();
      const slots = document.querySelectorAll('.slot[data-save="1"]');

      if (d && d.slots) {
        d.slots.forEach((item, i) => {
          const slot = slots[i];
          if (!slot) return;

          const textEl = slot.querySelector('.slot-text');

          // ìƒíƒœ ë°˜ì˜
          if (item.filled) slot.classList.add('filled'); else slot.classList.remove('filled');
          if (item.un) slot.classList.add('is-unassigned'); else slot.classList.remove('is-unassigned');

          // ìˆ˜ê¸°í‘œê¸° ìš°ì„ 
          if (item.manualText && item.manualText.trim() !== "") {
            slot.dataset.manualText = item.manualText;
            slot.classList.add('manual-locked');
            if (textEl) textEl.innerText = item.manualText.replace('ë™ ', 'ë™\n');
            slot.classList.add('filled'); // ìˆ˜ê¸°í‘œê¸°ëŠ” ì‚¬ìš©ì¤‘ í‘œì‹œ(ì›ì¹˜ ì•Šìœ¼ë©´ ì‚­ì œ)
          } else {
            delete slot.dataset.manualText;
            slot.classList.remove('manual-locked');
            if (textEl) textEl.innerText = item.text;
          }
        });

        if (d.report) {
          document.getElementById('summaryArea').innerHTML = d.report;
          document.getElementById('summaryArea').style.display = 'block';
        }

        if (!isAdmin) document.getElementById('unitWrapper').style.display = 'none';
      }
    });
  }

  // --- ì´ë¯¸ì§€ ì €ì¥ ---
  function saveAsImage() {
    html2canvas(document.getElementById('printArea'), { scale: 2 }).then(canvas => {
      const a = document.createElement('a');
      a.download = 'parking_map.png';
      a.href = canvas.toDataURL();
      a.click();
    });
  }

  init();
</script>
</body>
</html>
