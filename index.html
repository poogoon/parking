<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>í¸ë°±ë‚˜ë¬´ ì£¼ì°¨ ê´€ë¦¬ ì‹œìŠ¤í…œ</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root { --primary: #34495e; --accent: #3182ce; --danger: #e53e3e; --joint: #f8fafc; }
        body { font-family: 'Apple SD Gothic Neo', sans-serif; text-align: center; background-color: #f4f7f9; margin: 0; padding: 20px; color: #333; }
        .container { max-width: 1100px; margin: auto; background: white; padding: 30px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        
        h1 { cursor: pointer; user-select: none; margin-bottom: 5px; }
        .admin-badge { display: none; color: #3182ce; font-size: 14px; font-weight: bold; margin-bottom: 20px; border: 1px solid #3182ce; display: inline-block; padding: 2px 10px; border-radius: 20px; margin-top: 10px; }

        .summary-box { display: none; background: #fff; border: 3px solid var(--accent); padding: 25px; border-radius: 15px; margin: 20px 0 40px 0; text-align: left; }
        .wait-list { color: var(--danger); background: #fff5f5; padding: 18px; border-radius: 8px; border: 1px solid #fed7d7; margin-top: 10px; font-weight: bold; line-height: 1.6; }
        .wait-name { color: #000; font-weight: 800; margin-left: 4px; margin-right: 12px; }

        /* ì„¸ëŒ€ ë¦¬ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ */
        .dong-wrapper { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 30px; }
        .dong-column { flex: 1; min-width: 300px; background: #fff; padding: 15px; border-radius: 12px; border: 1px solid #e2e8f0; }
        .dong-title { font-weight: bold; margin-bottom: 10px; padding: 8px; background: #f8fafc; border-radius: 6px; border-bottom: 2px solid var(--primary); }
        .list-item { display: flex; align-items: center; justify-content: space-between; margin-bottom: 5px; font-size: 13px; padding: 4px 10px; border-radius: 4px; border: 1px solid #f1f5f9; }

        /* ì§€ë„ ìŠ¤íƒ€ì¼ */
        .map-section { margin: 20px 0; padding: 20px; background: #fdfdfd; border: 1px solid #cbd5e0; border-radius: 15px; }
        .map-container { display: flex; flex-direction: column; gap: 15px; align-items: center; }
        .building-box { width: 100%; border: 2px solid var(--primary); border-radius: 10px; padding: 45px 15px 20px; position: relative; background: white; box-sizing: border-box; }
        .joint-box { width: 100%; border: 1px dashed var(--accent); border-radius: 10px; padding: 25px 15px 15px; position: relative; background: var(--joint); box-sizing: border-box; }
        .label { position: absolute; top: -13px; left: 20px; padding: 3px 15px; font-size: 12px; border-radius: 4px; font-weight: bold; background: var(--primary); color: white; }
        .joint-label { background: var(--accent); }

        .parking-row { display: flex; justify-content: center; gap: 8px; margin: 8px 0; }
        .slot { width: 85px; height: 110px; border: 1px solid #dcdde1; border-radius: 6px; position: relative; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 12px; background: #fff; }
        .slot-toggle { position: absolute; top: 6px; left: 6px; transform: scale(1.3); cursor: pointer; z-index: 20; display: none; }
        .slot.is-unassigned { background-color: #f1f5f9 !important; border: 2px dashed #cbd5e0 !important; color: #94a3b8 !important; }
        .slot.filled { background-color: #ebf8ff !important; border: 2px solid var(--accent) !important; color: var(--primary) !important; font-weight: bold; }

        .type-pillar { width: 40px; background: #95a5a6; color: white; border: none; writing-mode: vertical-lr; }
        .type-entrance { width: 100px; background: #3182ce; color: white; border: none; font-weight: bold; }
        .type-disabled { background-color: #2b6cb0; color: white; border: none; font-weight: bold; }

        #adminControls { display: none; margin: 20px 0; padding: 20px; background: #eef2f7; border-radius: 10px; border: 2px solid var(--accent); }
        .btn { padding: 15px 25px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 16px; margin: 5px; }
        .draw-btn { background: var(--primary); color: white; flex: 1; }
        .save-db-btn { background: #2f855a; color: white; }
        .save-img-btn { background: #718096; color: white; width: 100%; margin-top: 20px; }
        .driveway { font-size: 10px; color: #cbd5e0; letter-spacing: 12px; margin: 5px 0; font-weight: bold; }
        .loading-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); z-index: 1000; align-items: center; justify-content: center; font-weight: bold; }
    </style>
</head>
<body>

<div id="loading" class="loading-overlay">ì„œë²„ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</div>

<div class="container">
    <h1 onclick="handleAdminLogin()">í¸ë°±ë‚˜ë¬´ ì£¼ì°¨ êµ¬ì—­ ë°°ì •</h1>
    <div id="adminBadge" style="display:none;" class="admin-badge">ê´€ë¦¬ì ëª¨ë“œ ì ‘ì† ì¤‘</div>

    <div id="unitWrapper" class="dong-wrapper">
        <div class="dong-column"><div class="dong-title">Aë™ ì„¸ëŒ€</div><div id="list-A"></div></div>
        <div class="dong-column"><div class="dong-title">Bë™ ì„¸ëŒ€</div><div id="list-B"></div></div>
        <div class="dong-column"><div class="dong-title">Cë™ ì„¸ëŒ€</div><div id="list-C"></div></div>
    </div>

    <div id="printArea">
        <div id="summaryArea" class="summary-box"></div>
        <div class="map-section">
            <h2 id="printTitle" style="display:none; margin-bottom:20px;">ğŸš— ì£¼ì°¨ êµ¬ì—­ ë°°ì • ê²°ê³¼</h2>
            <div class="map-container" id="mainMap"></div>
        </div>
    </div>

    <div id="adminControls">
        <h4 style="margin-top:0;">ğŸ› ï¸ ê´€ë¦¬ì ë„êµ¬</h4>
        <div style="display: flex;">
            <button class="btn draw-btn" onclick="executeDraw()">ğŸ² ì¶”ì²¨ ì‹œì‘</button>
            <button class="btn save-db-btn" onclick="saveToFirebase()">ğŸ’¾ ì„œë²„ì— ê²°ê³¼ ì €ì¥</button>
        </div>
        <button class="btn save-img-btn" onclick="saveAsImage()">ğŸ“¸ A4 ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ</button>
    </div>
</div>

<script>
    // [ì¤‘ìš”] ì•„ë˜ 3ê°€ì§€ ê°’ì„ ê´€ë¦¬ìë‹˜ì˜ Firebase ì„¤ì •ê°’ìœ¼ë¡œ ë°”ê¾¸ì„¸ìš”!
    const firebaseConfig = {
        apiKey: "YOUR_API_KEY",
        databaseURL: "YOUR_DATABASE_URL",
        projectId: "YOUR_PROJECT_ID"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    
    let isAdmin = false;
    let clickCount = 0;
    const adminPass = "1234"; // ë¹„ë°€ë²ˆí˜¸

    // 1. í˜ì´ì§€ ì‹œì‘
    function init() {
        createUnitList();
        renderMap();
        loadFromFirebase();
    }

    // 2. ì„¸ëŒ€ ë¦¬ìŠ¤íŠ¸ ìƒì„±
    function createUnitList() {
        const skipUnits = ['Aë™ 201í˜¸', 'Aë™ 202í˜¸', 'Aë™ 401í˜¸', 'Cë™ 202í˜¸', 'Cë™ 502í˜¸'];
        const fixedUnits = ['Bë™ 302í˜¸', 'Cë™ 403í˜¸'];

        ['A','B','C'].forEach(dong => {
            const container = document.getElementById('list-' + dong);
            container.innerHTML = "";
            for(let f=2; f<=5; f++){
                let rooms = (dong === 'B' && f > 3) || (dong === 'C' && f === 5) ? 2 : 3;
                for(let r=1; r<=rooms; r++){
                    let name = `${dong}ë™ ${f}0${r}í˜¸`;
                    let isChecked = !skipUnits.includes(name) && !fixedUnits.includes(name);
                    container.innerHTML += `
                        <div class="list-item">
                            <label><input type="checkbox" class="chk-draw" ${isChecked?'checked':''} value="${name}" data-dong="${dong}" disabled> ${f}0${r}í˜¸</label>
                        </div>`;
                }
            }
        });
    }

    // 3. ì§€ë„ ê·¸ë¦¬ê¸°
    function renderMap() {
        const map = document.getElementById('mainMap');
        const makeRow = (layout, dongTag) => `<div class="parking-row">` + layout.map(t => {
            if(t === 'P') return `<div class="slot type-pillar">ê¸°ë‘¥</div>`;
            if(t === 'E') return `<div class="slot type-entrance">ğŸšª<br>ì¶œì…ë¬¸</div>`;
            if(t === 'D') return `<div class="slot type-disabled">â™¿<br>ì¥ì• ì¸</div>`;
            return `<div class="slot" data-role="parking" data-dong="${dongTag}">
                        <input type="checkbox" class="slot-toggle" checked onchange="updateSlotStyle(this)">
                        <strong class="slot-text">${dongTag}êµ¬ì—­</strong>
                    </div>`;
        }).join('') + `</div>`;

        map.innerHTML = `
            <div class="building-box"><div class="label">Aë™ í•„ë¡œí‹°</div>${makeRow(['S','S','P','S','E','S','P','S'], 'A')}<div class="driveway">DRIVEWAY</div>${makeRow(['S','S','P','S','P','D'], 'A')}</div>
            <div class="joint-box"><div class="label joint-label">A-Bë™ ê³µë™êµ¬ì—­</div>${makeRow(['D', 'S'], 'AB')}${makeRow(['S', 'S'], 'AB')}</div>
            <div class="building-box"><div class="label">Bë™ í•„ë¡œí‹°</div>${makeRow(['S','S','E','S','S'], 'B')}<div class="driveway">DRIVEWAY</div>${makeRow(['S','S','P','S','P','S','S'], 'B')}</div>
            <div class="joint-box"><div class="label joint-label">B-Cë™ ê³µë™êµ¬ì—­</div>${makeRow(['S', 'S'], 'BC')}${makeRow(['S', 'S'], 'BC')}</div>
            <div class="building-box"><div class="label">Cë™ í•„ë¡œí‹°</div>${makeRow(['S','S','E','S','S'], 'C')}<div class="driveway">DRIVEWAY</div>${makeRow(['D','P','S','S'], 'C')}</div>`;
    }

    // 4. ê´€ë¦¬ì ë¡œê·¸ì¸
    function handleAdminLogin() {
        clickCount++;
        if (clickCount >= 5) {
            const pw = prompt("ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
            if (pw === adminPass) {
                isAdmin = true;
                document.getElementById('adminControls').style.display = 'block';
                document.getElementById('adminBadge').style.display = 'inline-block';
                document.getElementById('unitWrapper').style.display = 'flex';
                document.querySelectorAll('.slot-toggle').forEach(el => el.style.display = 'block');
                document.querySelectorAll('.chk-draw').forEach(el => el.disabled = false);
                alert("ê´€ë¦¬ì ëª¨ë“œ í™œì„±í™”ë¨!");
            }
            clickCount = 0;
        }
    }

    // 5. ì„œë²„ì—ì„œ ê°€ì ¸ì˜¤ê¸°
    function loadFromFirebase() {
        document.getElementById('loading').style.display = 'flex';
        db.ref('parking_result').once('value', (snapshot) => {
            const data = snapshot.val();
            if (data && data.slots) {
                const slots = document.querySelectorAll('.slot[data-role="parking"]');
                data.slots.forEach((item, idx) => {
                    const s = slots[idx];
                    if (s) {
                        s.querySelector('.slot-text').innerText = item.text;
                        if(item.isFilled) s.classList.add('filled');
                        if(item.isUnassigned) s.classList.add('is-unassigned');
                    }
                });
                document.getElementById('summaryArea').innerHTML = data.report;
                document.getElementById('summaryArea').style.display = 'block';
                if(!isAdmin) document.getElementById('unitWrapper').style.display = 'none';
            }
            document.getElementById('loading').style.display = 'none';
        }).catch(() => { document.getElementById('loading').style.display = 'none'; });
    }

    // 6. ì¶”ì²¨ ë¡œì§
    function executeDraw() {
        let allApps = Array.from(document.querySelectorAll('.chk-draw:checked')).map(e => ({ name: e.value, dong: e.dataset.dong }));
        let activeSlots = Array.from(document.querySelectorAll('.slot[data-role="parking"]')).filter(s => !s.classList.contains('is-unassigned'));
        if (allApps.length === 0) return alert("ì‹ ì²­ ì„¸ëŒ€ê°€ ì—†ìŠµë‹ˆë‹¤.");
        
        let shuffledApps = allApps.sort(() => Math.random() - 0.5);
        let winners = (allApps.length > activeSlots.length) ? shuffledApps.slice(allApps.length - activeSlots.length) : [...allApps];
        let losers = (allApps.length > activeSlots.length) ? shuffledApps.slice(0, allApps.length - activeSlots.length) : [];

        activeSlots.forEach(s => { s.querySelector('.slot-text').innerText = ""; s.classList.remove('filled'); });

        let appsByDong = { A: winners.filter(a => a.dong === 'A'), B: winners.filter(a => a.dong === 'B'), C: winners.filter(a => a.dong === 'C') };
        let slots = { A: activeSlots.filter(s => s.dataset.dong === 'A'), B: activeSlots.filter(s => s.dataset.dong === 'B'), C: activeSlots.filter(s => s.dataset.dong === 'C'), AB: activeSlots.filter(s => s.dataset.dong === 'AB'), BC: activeSlots.filter(s => s.dataset.dong === 'BC') };

        ['A','B','C'].forEach(d => {
            slots[d].forEach(s => { if(appsByDong[d].length > 0) { const p = appsByDong[d].shift(); s.querySelector('.slot-text').innerText = p.name.replace('ë™ ', 'ë™\n'); s.classList.add('filled'); } });
        });

        let leftovers = [...appsByDong.A, ...appsByDong.B, ...appsByDong.C];
        [...slots.AB, ...slots.BC].forEach(s => {
            if(leftovers.length > 0) { const p = leftovers.shift(); s.querySelector('.slot-text').innerText = p.name.replace('ë™ ', 'ë™\n'); s.classList.add('filled'); }
            else { s.querySelector('.slot-text').innerHTML = '<span style="color:#cbd5e0">ê³µì„</span>'; }
        });

        const sArea = document.getElementById('summaryArea');
        sArea.style.display = 'block';
        const loserHtml = losers.map((l, i) => `[${i+1}ìˆœìœ„] <span class="wait-name">${l.name}</span>`).join(' ');
        sArea.innerHTML = `<h3>ğŸ“Š ì¶”ì²¨ ê²°ê³¼ ë¦¬í¬íŠ¸</h3><p>â€¢ êµ¬ì—­: ${activeSlots.length}ê°œ | ì‹ ì²­: ${allApps.length}ì„¸ëŒ€</p><p>â€¢ ë‹¹ì²¨: ${winners.length}ì„¸ëŒ€</p>${losers.length > 0 ? `<div class="wait-list">âš ï¸ ë¯¸ë‹¹ì²¨ ëŒ€ê¸° ëª…ë‹¨:<br>${loserHtml}</div>` : ''}`;
    }

    // 7. ì„œë²„ ì €ì¥
    function saveToFirebase() {
        if (!confirm("ê²°ê³¼ë¥¼ ì„œë²„ì— ì €ì¥í• ê¹Œìš”?")) return;
        const slotsData = [];
        document.querySelectorAll('.slot[data-role="parking"]').forEach((s, idx) => {
            slotsData.push({ idx: idx, text: s.querySelector('.slot-text').innerText, isFilled: s.classList.contains('filled'), isUnassigned: s.classList.contains('is-unassigned') });
        });
        db.ref('parking_result').set({ slots: slotsData, report: document.getElementById('summaryArea').innerHTML }).then(() => alert("ì €ì¥ ì™„ë£Œ!"));
    }

    // 8. ì´ë¯¸ì§€ ì €ì¥
    function saveAsImage() {
        const area = document.getElementById('printArea');
        document.getElementById('printTitle').style.display = 'block';
        html2canvas(area, { scale: 2, backgroundColor: "#ffffff" }).then(canvas => {
            const link = document.createElement('a');
            link.download = 'ì£¼ì°¨ë°°ì •ê²°ê³¼.png';
            link.href = canvas.toDataURL();
            link.click();
            document.getElementById('printTitle').style.display = 'none';
        });
    }

    function updateSlotStyle(chk) {
        const slot = chk.closest('.slot');
        const text = slot.querySelector('.slot-text');
        const dong = slot.getAttribute('data-dong');
        if (chk.checked) { slot.classList.remove('is-unassigned'); text.innerText = `${dong}êµ¬ì—­`; }
        else { slot.classList.add('is-unassigned'); text.innerText = "ë¹„ì§€ì •ì„"; }
    }

    init();
</script>
</body>
</html>
