<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>í¸ë°±ë‚˜ë¬´ ì£¼ì°¨ ê´€ë¦¬ ì‹œìŠ¤í…œ</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root { --primary: #34495e; --accent: #3182ce; --danger: #e53e3e; --joint: #f8fafc; }
        body { font-family: 'Apple SD Gothic Neo', sans-serif; text-align: center; background-color: #f4f7f9; margin: 0; padding: 10px; color: #333; }
        
        /* ì»¨í…Œì´ë„ˆ */
        .container { max-width: 1200px; margin: auto; background: white; padding: 20px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        
        h1 { cursor: pointer; user-select: none; margin: 10px 0; font-size: 1.5rem; }
        .admin-badge { display: none; background: var(--accent); color: white; padding: 4px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: bold; }

        /* ê²°ê³¼ ìš”ì•½ ë°•ìŠ¤ */
        .summary-box { display: none; background: #fff; border-left: 5px solid var(--accent); padding: 20px; margin: 20px 0; text-align: left; line-height: 1.6; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }

        /* ì„¸ëŒ€ ëª…ë‹¨ (ê´€ë¦¬ììš©) */
        .dong-wrapper { display: none; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; justify-content: center; }
        .dong-column { flex: 1; min-width: 150px; background: #fff; padding: 10px; border-radius: 8px; border: 1px solid #e2e8f0; }
        .dong-title { font-weight: bold; margin-bottom: 5px; padding: 5px; background: #f1f5f9; color: var(--primary); border-radius: 4px; }
        .list-item { display: flex; align-items: center; margin-bottom: 3px; font-size: 13px; border-bottom: 1px solid #f8f8f8; }
        
        /* â˜…â˜…â˜… ë§µ ì„¹ì…˜ (ê°€ë¡œ ìŠ¤í¬ë¡¤ í•µì‹¬) â˜…â˜…â˜… */
        .map-section { 
            width: 100%;
            overflow-x: auto; /* ê°€ë¡œ ìŠ¤í¬ë¡¤ í—ˆìš© */
            padding-bottom: 10px;
            background: #fdfdfd; 
            border: 1px solid #cbd5e0; 
            border-radius: 10px; 
            -webkit-overflow-scrolling: touch; /* ëª¨ë°”ì¼ ë¶€ë“œëŸ¬ìš´ ìŠ¤í¬ë¡¤ */
        }

        /* ë§µ ì»¨í…Œì´ë„ˆ: ì ˆëŒ€ ì¤„ë°”ê¿ˆ ì•ˆë˜ê²Œ ê°•ì œ ì„¤ì • */
        .map-container { 
            display: flex; 
            flex-direction: row; /* ê°€ë¡œ ì •ë ¬ */
            flex-wrap: nowrap; /* ì¤„ë°”ê¿ˆ ê¸ˆì§€ */
            align-items: flex-start; 
            gap: 10px; 
            padding: 20px;
            min-width: 1000px; /* â˜…ì¤‘ìš”: ë‚´ë¶€ ì½˜í…ì¸ ì˜ ìµœì†Œ ë„ˆë¹„ í™•ë³´ */
            margin: 0 auto;
        }

        /* ìŠ¤í¬ë¡¤ ì•ˆë‚´ ë¬¸êµ¬ */
        .scroll-hint { display: block; font-size: 12px; color: #718096; margin-bottom: 5px; }
        @media (min-width: 1024px) { .scroll-hint { display: none; } }

        /* ê±´ë¬¼ ë°•ìŠ¤ */
        .building-box { flex: 0 0 240px; border: 2px solid var(--primary); border-radius: 10px; padding: 40px 10px 10px; position: relative; background: white; }
        .joint-box { flex: 0 0 180px; border: 2px dashed var(--accent); border-radius: 10px; padding: 25px 10px 10px; position: relative; background: var(--joint); margin-top: 40px; /* ë†’ì´ ë§ì¶¤ */ }
        
        .label { position: absolute; top: -12px; left: 50%; transform: translateX(-50%); padding: 4px 15px; font-size: 12px; border-radius: 15px; font-weight: bold; background: var(--primary); color: white; white-space: nowrap; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .joint-label { background: var(--accent); }

        /* ì£¼ì°¨ ìŠ¬ë¡¯ */
        .parking-row { display: flex; justify-content: center; gap: 5px; margin-bottom: 5px; }
        .slot { width: 70px; height: 90px; border: 1px solid #cbd5e0; border-radius: 5px; position: relative; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 12px; background: #fff; white-space: pre-line; box-shadow: 2px 2px 5px rgba(0,0,0,0.03); }
        .slot-toggle { position: absolute; top: 2px; left: 2px; z-index: 10; display: none; }
        
        .filled { background-color: #e6fffa !important; border: 2px solid #38b2ac !important; color: #234e52 !important; font-weight: bold; }
        .is-unassigned { background-color: #edf2f7 !important; border: 2px dashed #a0aec0 !important; color: #a0aec0 !important; }
        
        .type-pillar { width: 30px; background: #a0aec0; border: none; }
        .type-entrance { width: 60px; background: #34495e; color: white; font-weight: bold; font-size: 11px; border:none; }
        .type-disabled { background-color: #3182ce; color: white; font-weight: bold; border:none; }

        /* ê´€ë¦¬ì ë²„íŠ¼ */
        #adminControls { display: none; margin-top: 20px; padding: 20px; background: #fff5f5; border-radius: 10px; border: 1px solid var(--danger); }
        .btn { padding: 10px 15px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; margin: 5px; color: white; font-size: 14px; }
        .draw-btn { background: var(--primary); }
        .save-db-btn { background: #38a169; }
        .reset-db-btn { background: var(--danger); }
        .save-img-btn { background: #718096; width: 100%; display: block; margin-top: 10px; }
    </style>
</head>
<body>

<div class="container">
    <h1 onclick="handleAdminLogin()">ğŸš™ í¸ë°±ë‚˜ë¬´ ì£¼ì°¨ ë°°ì •</h1>
    <span id="adminBadge" class="admin-badge">ê´€ë¦¬ì ëª¨ë“œ</span>

    <div id="unitWrapper" class="dong-wrapper">
        <div class="dong-column"><div class="dong-title">Aë™ ì‹ ì²­</div><div id="list-A"></div></div>
        <div class="dong-column"><div class="dong-title">Bë™ ì‹ ì²­</div><div id="list-B"></div></div>
        <div class="dong-column"><div class="dong-title">Cë™ ì‹ ì²­</div><div id="list-C"></div></div>
    </div>

    <div id="printArea">
        <div id="summaryArea" class="summary-box"></div>
        
        <p class="scroll-hint">ğŸ‘ˆ ì¢Œìš°ë¡œ ìŠ¤í¬ë¡¤í•˜ì—¬ ì „ì²´ ì§€ë„ë¥¼ í™•ì¸í•˜ì„¸ìš” ğŸ‘‰</p>
        <div class="map-section">
            <div class="map-container" id="mainMap">
                </div>
        </div>
    </div>

    <div id="adminControls">
        <p style="font-weight: bold; color: var(--danger); margin-bottom: 10px;">âš™ï¸ ê´€ë¦¬ì ì œì–´íŒ</p>
        <div style="display: flex; justify-content: center; flex-wrap: wrap;">
            <button class="btn draw-btn" onclick="executeRulesDraw()">ğŸ² ê·œì¹™ê¸°ë°˜ ì¶”ì²¨ ì‹¤í–‰</button>
            <button class="btn save-db-btn" onclick="saveToFirebase()">ğŸ’¾ ê²°ê³¼ ì €ì¥</button>
            <button class="btn reset-db-btn" onclick="resetDatabase()">ğŸ§¹ ì´ˆê¸°í™”</button>
        </div>
        <button class="btn save-img-btn" onclick="saveAsImage()">ğŸ“¸ ì´ë¯¸ì§€ ì €ì¥</button>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyC0jloY1-k3bzz4HuPrmpL0wdtzHYMw-FE",
        databaseURL: "https://parking-bd6fa-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "parking-bd6fa"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    
    let isAdmin = false;
    let clickCount = 0;

    // ì„¤ì • ë°ì´í„°
    const skipList = ['Aë™ 201í˜¸', 'Aë™ 202í˜¸', 'Aë™ 401í˜¸', 'Cë™ 202í˜¸', 'Cë™ 502í˜¸'];
    // Cë™ 403í˜¸ëŠ” Cë™ ì¥ì• ì¸ êµ¬ì—­ì— ê³ ì • (ì¶”ì²¨ ì œì™¸)
    const fixedList = { 'Cë™ 403í˜¸': 'Cë™ ì¥ì• ì¸' }; 

    function init() {
        createUnitList();
        renderMap();
        loadFromFirebase();
    }

    function createUnitList() {
        ['A','B','C'].forEach(dong => {
            const container = document.getElementById('list-' + dong);
            container.innerHTML = "";
            for(let f=2; f<=5; f++){
                let rooms = (dong === 'B' && f > 3) || (dong === 'C' && f === 5) ? 2 : 3;
                for(let r=1; r<=rooms; r++){
                    let name = `${dong}ë™ ${f}0${r}í˜¸`;
                    let isSkipped = skipList.includes(name);
                    let isFixed = fixedList[name] !== undefined;
                    let labelText = name;
                    
                    if(isSkipped) labelText += " <span style='color:#ccc'>(ì œì™¸)</span>";
                    if(isFixed) labelText += " <span style='color:blue;font-weight:bold'>(ê³ ì •)</span>";

                    // ê³ ì •ì´ê±°ë‚˜ ì œì™¸ë©´ ì²´í¬ë°•ìŠ¤ í•´ì œ ë° ë¹„í™œì„±
                    let checked = !isSkipped && !isFixed ? 'checked' : '';
                    let disabled = 'disabled'; // ê¸°ë³¸ì ìœ¼ë¡œ ë¹„í™œì„±, ê´€ë¦¬ì ëª¨ë“œì—ì„œ í’€ë¦¼

                    container.innerHTML += `<div class="list-item"><label><input type="checkbox" class="chk-draw" ${checked} value="${name}" data-dong="${dong}" ${disabled}> ${labelText}</label></div>`;
                }
            }
        });
    }

    function renderMap() {
        const map = document.getElementById('mainMap');
        const makeRow = (layout, zone) => `<div class="parking-row">` + layout.map(t => {
            if(t === 'P') return `<div class="slot type-pillar"></div>`;
            if(t === 'E') return `<div class="slot type-entrance">ì¶œì…êµ¬</div>`;
            if(t === 'D') {
                // Cë™ì¼ ê²½ìš° 403í˜¸ ê³ ì • í…ìŠ¤íŠ¸ í‘œì‹œ
                let txt = zone === 'C' ? 'Cì¥ì• ì¸\n(403í˜¸)' : 'ì¥ì• ì¸';
                return `<div class="slot type-disabled">${txt}</div>`;
            }
            return `<div class="slot" data-role="parking" data-zone="${zone}"><input type="checkbox" class="slot-toggle" checked onchange="updateStyle(this)"><strong class="slot-text">${zone}êµ¬ì—­</strong></div>`;
        }).join('') + `</div>`;

        map.innerHTML = `
            <div class="building-box"><div class="label">Aë™ í•„ë¡œí‹° (Aì „ìš©)</div>${makeRow(['S','S','P','S','E','S','P','S'], 'A')}${makeRow(['S','S','P','S','P','D'], 'A')}</div>
            <div class="joint-box"><div class="label joint-label">A-B ê³µë™ (A,Bì”ì—¬)</div>${makeRow(['D', 'S'], 'AB')}${makeRow(['S', 'S'], 'AB')}</div>
            <div class="building-box"><div class="label">Bë™ í•„ë¡œí‹° (Bì „ìš©)</div>${makeRow(['S','S','E','S','S'], 'B')}${makeRow(['S','S','P','S','P','S','S'], 'B')}</div>
            <div class="joint-box"><div class="label joint-label">B-C ê³µë™ (B,Cì”ì—¬)</div>${makeRow(['S', 'S'], 'BC')}${makeRow(['S', 'S'], 'BC')}</div>
            <div class="building-box"><div class="label">Cë™ í•„ë¡œí‹° (Cì „ìš©)</div>${makeRow(['S','S','E','S','S'], 'C')}${makeRow(['D','P','S','S'], 'C')}</div>`;
    }

    // â˜…â˜…â˜… í•µì‹¬: ê·œì¹™ ê¸°ë°˜ ì¶”ì²¨ ì•Œê³ ë¦¬ì¦˜ â˜…â˜…â˜…
    function executeRulesDraw() {
        if(!confirm("ê¸°ì¡´ ë°°ì •ì„ ì´ˆê¸°í™”í•˜ê³  ê·œì¹™ì— ë”°ë¼ ìƒˆë¡œ ì¶”ì²¨í•©ë‹ˆë‹¤.")) return;

        // 1. ì‹ ì²­ì ëª…ë‹¨ ê°€ì ¸ì˜¤ê¸°
        const applicants = Array.from(document.querySelectorAll('.chk-draw:checked')).map(e => ({ name: e.value, dong: e.dataset.dong }));
        
        if (applicants.length === 0) return alert("ì‹ ì²­ ì„¸ëŒ€ê°€ ì—†ìŠµë‹ˆë‹¤.");

        // 2. êµ¬ì—­ë³„ ì£¼ì°¨ì¹¸(Slot) ê°€ì ¸ì˜¤ê¸° (ë¹„ì§€ì • í•´ì œëœ ì¹¸ ì œì™¸)
        const getActiveSlots = (zone) => Array.from(document.querySelectorAll(`.slot[data-zone="${zone}"]`)).filter(s => !s.classList.contains('is-unassigned'));
        
        const slotsA = getActiveSlots('A');
        const slotsB = getActiveSlots('B');
        const slotsC = getActiveSlots('C');
        const slotsAB = getActiveSlots('AB');
        const slotsBC = getActiveSlots('BC');

        // ì´ˆê¸°í™”
        document.querySelectorAll('.slot[data-role="parking"]').forEach(s => {
            s.querySelector('.slot-text').innerText = s.dataset.zone + "êµ¬ì—­";
            s.classList.remove('filled');
        });

        // ì…”í”Œ í•¨ìˆ˜
        const shuffle = (arr) => arr.sort(() => Math.random() - 0.5);

        // ê·¸ë£¹ ë‚˜ëˆ„ê¸°
        let groupA = shuffle(applicants.filter(p => p.dong === 'A'));
        let groupB = shuffle(applicants.filter(p => p.dong === 'B'));
        let groupC = shuffle(applicants.filter(p => p.dong === 'C')); // 403í˜¸ëŠ” ì´ë¯¸ ì œì™¸ë¨

        // [Rule 1,2,3] ê° ë™ í•„ë¡œí‹° ìš°ì„  ë°°ì •
        function assign(people, slots) {
            let winners = people.slice(0, slots.length);
            let remain = people.slice(slots.length);
            winners.forEach((p, i) => {
                slots[i].querySelector('.slot-text').innerText = p.name.replace('ë™ ', '\n');
                slots[i].classList.add('filled');
            });
            return { winners, remain };
        }

        let resA = assign(groupA, slotsA);
        let resB = assign(groupB, slotsB);
        let resC = assign(groupC, slotsC);

        // [Rule 4] A-B ê³µë™êµ¬ì—­: Aì”ì—¬ + Bì”ì—¬
        let poolAB = shuffle([...resA.remain, ...resB.remain]);
        let resAB = assign(poolAB, slotsAB); // ì—¬ê¸°ì„œ ë–¨ì–´ì§„ ì‚¬ëŒì€ Aì”ì—¬ ë˜ëŠ” Bì”ì—¬ì„

        // [Rule 5] B-C ê³µë™êµ¬ì—­: (A-Bì—ì„œ ë–¨ì–´ì§„ B) + Cì”ì—¬
        // ì£¼ì˜: ABì—ì„œ ë–¨ì–´ì§„ AëŠ” ê°ˆê³³ì´ ì—†ìŒ. ABì—ì„œ ë–¨ì–´ì§„ Bë§Œ êµ¬ì œí•˜ì—¬ Cì™€ ê²½ìŸ
        let failedFromAB_B = resAB.remain.filter(p => p.dong === 'B');
        let failedFromAB_A = resAB.remain.filter(p => p.dong === 'A'); // ìµœì¢… íƒˆë½ A

        let poolBC = shuffle([...failedFromAB_B, ...resC.remain]);
        let resBC = assign(poolBC, slotsBC);

        // ìµœì¢… ê²°ê³¼ ì§‘ê³„
        let totalWin = resA.winners.length + resB.winners.length + resC.winners.length + resAB.winners.length + resBC.winners.length;
        let finalFail = [...failedFromAB_A, ...resBC.remain];

        // ë¦¬í¬íŠ¸ ì¶œë ¥
        const sArea = document.getElementById('summaryArea');
        sArea.style.display = 'block';
        let report = `
            <h3>ğŸ“Š ì¶”ì²¨ ê²°ê³¼ ë¦¬í¬íŠ¸</h3>
            <p>â€¢ ì´ ì‹ ì²­: ${applicants.length}ì„¸ëŒ€ / ë‹¹ì²¨: ${totalWin}ì„¸ëŒ€</p>
            <ul style="padding-left:20px; margin:10px 0;">
                <li>Aë™ í•„ë¡œí‹° ë°°ì •: ${resA.winners.length}</li>
                <li>Bë™ í•„ë¡œí‹° ë°°ì •: ${resB.winners.length}</li>
                <li>Cë™ í•„ë¡œí‹° ë°°ì •: ${resC.winners.length}</li>
                <li>ê³µë™êµ¬ì—­ ì¶”ê°€ ë°°ì •: ${resAB.winners.length + resBC.winners.length}</li>
            </ul>
        `;
        if(finalFail.length > 0) {
            report += `<div style="color:red; font-weight:bold;">ğŸ˜¢ ìµœì¢… ëŒ€ê¸°ì (${finalFail.length}): ${finalFail.map(p=>p.name).join(', ')}</div>`;
        } else {
            report += `<div style="color:green; font-weight:bold;">ğŸ‰ ì‹ ì²­ì ì „ì› ì£¼ì°¨ ê°€ëŠ¥!</div>`;
        }
        sArea.innerHTML = report;
    }

    function handleAdminLogin() {
        if (++clickCount >= 5) {
            if (prompt("ê´€ë¦¬ì ì•”í˜¸") === "1234") {
                isAdmin = true;
                document.getElementById('adminControls').style.display = 'block';
                document.getElementById('adminBadge').style.display = 'inline-block';
                document.getElementById('unitWrapper').style.display = 'flex';
                document.querySelectorAll('.chk-draw').forEach(el => el.disabled = false);
                document.querySelectorAll('.slot-toggle').forEach(el => el.style.display = 'block');
            }
            clickCount = 0;
        }
    }

    function updateStyle(c) {
        const s = c.closest('.slot');
        if (c.checked) {
            s.classList.remove('is-unassigned');
            s.querySelector('.slot-text').innerText = s.dataset.zone + "êµ¬ì—­";
        } else {
            s.classList.add('is-unassigned');
            s.querySelector('.slot-text').innerText = "ë¹„ì§€ì •";
        }
    }

    function saveToFirebase() {
        if (!confirm("í˜„ì¬ ìƒíƒœë¥¼ ì„œë²„ì— ì €ì¥í•©ë‹ˆê¹Œ?")) return;
        const slotsData = Array.from(document.querySelectorAll('.slot[data-role="parking"]')).map(s => ({
            text: s.querySelector('.slot-text').innerText,
            filled: s.classList.contains('filled'),
            un: s.classList.contains('is-unassigned'),
            zone: s.dataset.zone
        }));
        db.ref('parking_result').set({ slots: slotsData, report: document.getElementById('summaryArea').innerHTML })
            .then(() => alert("ì €ì¥ ì™„ë£Œ!"));
    }

    function resetDatabase() {
        if (confirm("ì •ë§ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
            db.ref('parking_result').remove().then(() => location.reload());
        }
    }

    function loadFromFirebase() {
        db.ref('parking_result').on('value', s => {
            const d = s.val();
            const slots = document.querySelectorAll('.slot[data-role="parking"]');
            
            if (d && d.slots) {
                d.slots.forEach((item, i) => {
                    if (slots[i]) {
                        slots[i].querySelector('.slot-text').innerText = item.text;
                        if (item.filled) slots[i].classList.add('filled'); else slots[i].classList.remove('filled');
                        if (item.un) slots[i].classList.add('is-unassigned'); else slots[i].classList.remove('is-unassigned');
                    }
                });
                if (d.report) {
                    document.getElementById('summaryArea').innerHTML = d.report;
                    document.getElementById('summaryArea').style.display = 'block';
                }
                if (!isAdmin) document.getElementById('unitWrapper').style.display = 'none';
            }
        });
    }

    function saveAsImage() {
        window.scrollTo(0,0);
        html2canvas(document.getElementById('printArea'), { scale: 2 }).then(canvas => {
            const a = document.createElement('a');
            a.download = 'parking_map.png';
            a.href = canvas.toDataURL();
            a.click();
        });
    }

    init();
</script>
</body>
</html>
